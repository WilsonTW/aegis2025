<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>aegis documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">aegis documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >PowerSchedulerExService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/power_scheduler/power_schedulerex.service.ts</code>
        </p>



            <p class="comment">
                <h3>Extends</h3>
            </p>
            <p class="comment">
                            <code><a href="../injectables/PowerSchedulerService.html" target="_self" >PowerSchedulerService</a></code>
            </p>


            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#appService" >appService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceDataService" >deviceDataService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceExService" >deviceExService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceService" >deviceService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceTypeService" >deviceTypeService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#domainServiceEx" >domainServiceEx</a>
                            </li>
                            <li>
                                    <span class="modifier"></span>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#powerSchedulerRepository" >powerSchedulerRepository</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#powerSchedulerService" >powerSchedulerService</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#clearCronTask" >clearCronTask</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#dispatch" >dispatch</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPomcubeData" >getPomcubeData</a>
                            </li>
                            <li>
                                <a href="#isCronTaskRunning" >isCronTaskRunning</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#notify" >notify</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#onModuleInit" >onModuleInit</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#queryHistory" >queryHistory</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#startCronTask" >startCronTask</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#startNowCronTask" >startNowCronTask</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateCronTasks" >updateCronTasks</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#writeInfluxdb" >writeInfluxdb</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#create" >create</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#findAll" >findAll</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#findOne" >findOne</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#remove" >remove</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#update" >update</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(powerSchedulerRepository: Repository<PowerScheduler>, appService: <a href="../injectables/AppService.html" target="_self">AppService</a>, powerSchedulerService: <a href="../injectables/PowerSchedulerService.html" target="_self">PowerSchedulerService</a>, domainServiceEx: <a href="../injectables/DomainService.html" target="_self">DomainService</a>, deviceTypeService: <a href="../injectables/DeviceTypeService.html" target="_self">DeviceTypeService</a>, deviceService: <a href="../injectables/DeviceService.html" target="_self">DeviceService</a>, deviceExService: <a href="../injectables/DeviceService.html" target="_self">DeviceService</a>, deviceDataService: <a href="../injectables/DeviceDataService.html" target="_self">DeviceDataService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="34" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:34</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>powerSchedulerRepository</td>
                                                  
                                                        <td>
                                                                    <code>Repository&lt;PowerScheduler&gt;</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>appService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AppService.html" target="_self" >AppService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>powerSchedulerService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PowerSchedulerService.html" target="_self" >PowerSchedulerService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>domainServiceEx</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceTypeService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceTypeService.html" target="_self" >DeviceTypeService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceService.html" target="_self" >DeviceService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceExService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceService.html" target="_self" >DeviceService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceDataService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceDataService.html" target="_self" >DeviceDataService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="clearCronTask"></a>
                    <span class="name">
                        <span ><b>clearCronTask</b></span>
                        <a href="#clearCronTask"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>clearCronTask()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="156"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:156</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="dispatch"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>dispatch</b></span>
                        <a href="#dispatch"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>dispatch(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, cron_task)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="173"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:173</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>cron_task</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPomcubeData"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getPomcubeData</b></span>
                        <a href="#getPomcubeData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPomcubeData(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, domain_id)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="220"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:220</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isCronTaskRunning"></a>
                    <span class="name">
                        <span ><b>isCronTaskRunning</b></span>
                        <a href="#isCronTaskRunning"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>isCronTaskRunning()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="527"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:527</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="notify"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>notify</b></span>
                        <a href="#notify"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>notify(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, notify_user_id, text)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="117"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:117</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>notify_user_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>text</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="onModuleInit"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>onModuleInit</b></span>
                        <a href="#onModuleInit"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>onModuleInit()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="49"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:49</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="queryHistory"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>queryHistory</b></span>
                        <a href="#queryHistory"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>queryHistory(power_scheduler: <a href="../classes/PowerScheduler.html" target="_self">PowerScheduler</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="677"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:677</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>power_scheduler</td>
                                            <td>
                                                            <code><a href="../classes/PowerScheduler.html" target="_self" >PowerScheduler</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="startCronTask"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>startCronTask</b></span>
                        <a href="#startCronTask"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>startCronTask(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, cron_task, start_power)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="252"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:252</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>cron_task</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>start_power</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="startNowCronTask"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>startNowCronTask</b></span>
                        <a href="#startNowCronTask"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>startNowCronTask(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="513"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:513</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateCronTasks"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>updateCronTasks</b></span>
                        <a href="#updateCronTasks"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateCronTasks(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="543"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:543</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="writeInfluxdb"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>writeInfluxdb</b></span>
                        <a href="#writeInfluxdb"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>writeInfluxdb(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, power_scheduler_id, domain_id, pstype, data, message: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, sell_energy: null, purchase_energy: null)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="134"
                                    class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:134</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>power_scheduler_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>pstype</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>message</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>&#x27;&#x27;</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>sell_energy</td>
                                            <td>
                                                        <code>null</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>purchase_energy</td>
                                            <td>
                                                        <code>null</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="create"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>create</b></span>
                        <a href="#create"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>create(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, powerScheduler: <a href="../classes/PowerSchedulerUpdate.html" target="_self">PowerSchedulerUpdate</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Inherited from         <code><a href="../injectables/PowerSchedulerServiceBase.html" target="_self" >PowerSchedulerServiceBase</a></code>
</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in         <code><a href="../injectables/PowerSchedulerServiceBase.html#source" target="_self" >PowerSchedulerServiceBase:13</a></code>
</div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>powerScheduler</td>
                                            <td>
                                                            <code><a href="../classes/PowerSchedulerUpdate.html" target="_self" >PowerSchedulerUpdate</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;PowerScheduler&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findAll"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>findAll</b></span>
                        <a href="#findAll"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findAll(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, options: null)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Inherited from         <code><a href="../injectables/PowerSchedulerServiceBase.html" target="_self" >PowerSchedulerServiceBase</a></code>
</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in         <code><a href="../injectables/PowerSchedulerServiceBase.html#source" target="_self" >PowerSchedulerServiceBase:18</a></code>
</div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>options</td>
                                            <td>
                                                        <code>null</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;PowerScheduler[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findOne"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>findOne</b></span>
                        <a href="#findOne"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findOne(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Inherited from         <code><a href="../injectables/PowerSchedulerServiceBase.html" target="_self" >PowerSchedulerServiceBase</a></code>
</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in         <code><a href="../injectables/PowerSchedulerServiceBase.html#source" target="_self" >PowerSchedulerServiceBase:22</a></code>
</div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;PowerScheduler&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="remove"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>remove</b></span>
                        <a href="#remove"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>remove(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Inherited from         <code><a href="../injectables/PowerSchedulerServiceBase.html" target="_self" >PowerSchedulerServiceBase</a></code>
</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in         <code><a href="../injectables/PowerSchedulerServiceBase.html#source" target="_self" >PowerSchedulerServiceBase:39</a></code>
</div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;boolean&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="update"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>update</b></span>
                        <a href="#update"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>update(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, updatePowerScheduler: <a href="../classes/PowerSchedulerUpdate.html" target="_self">PowerSchedulerUpdate</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Inherited from         <code><a href="../injectables/PowerSchedulerServiceBase.html" target="_self" >PowerSchedulerServiceBase</a></code>
</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in         <code><a href="../injectables/PowerSchedulerServiceBase.html#source" target="_self" >PowerSchedulerServiceBase:30</a></code>
</div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>updatePowerScheduler</td>
                                            <td>
                                                            <code><a href="../classes/PowerSchedulerUpdate.html" target="_self" >PowerSchedulerUpdate</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;PowerScheduler&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="appService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>appService</b></span>
                        <a href="#appService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/AppService.html" target="_self" >AppService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="38" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:38</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceDataService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceDataService</b></span>
                        <a href="#deviceDataService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceDataService.html" target="_self" >DeviceDataService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="44" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:44</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceExService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceExService</b></span>
                        <a href="#deviceExService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceService.html" target="_self" >DeviceService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="43" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:43</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceService</b></span>
                        <a href="#deviceService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceService.html" target="_self" >DeviceService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="42" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:42</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceTypeService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceTypeService</b></span>
                        <a href="#deviceTypeService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceTypeService.html" target="_self" >DeviceTypeService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="41" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:41</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="domainServiceEx"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>domainServiceEx</b></span>
                        <a href="#domainServiceEx"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="40" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:40</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="powerSchedulerRepository"></a>
                    <span class="name">
                            <span class="modifier"></span>
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>powerSchedulerRepository</b></span>
                        <a href="#powerSchedulerRepository"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>Repository&lt;PowerScheduler&gt;</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <b>Decorators : </b>
                        <br />
                        <code>
                            @InjectRepository(PowerScheduler)<br />
                        </code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Inherited from         <code><a href="../injectables/PowerSchedulerServiceBase.html" target="_self" >PowerSchedulerServiceBase</a></code>
</div>
                            </td>
                        </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in         <code><a href="../injectables/PowerSchedulerServiceBase.html#source" target="_self" >PowerSchedulerServiceBase:37</a></code>
</div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="powerSchedulerService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>powerSchedulerService</b></span>
                        <a href="#powerSchedulerService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/PowerSchedulerService.html" target="_self" >PowerSchedulerService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="39" class="link-to-prism">src/modules/power_scheduler/power_schedulerex.service.ts:39</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { HttpException, HttpStatus, Injectable, NotFoundException } from &#x27;@nestjs/common&#x27;;
import { InjectRepository } from &#x27;@nestjs/typeorm&#x27;;
import { Repository } from &#x27;typeorm&#x27;;
import { PowerScheduler } from &#x27;./power_scheduler.entity&#x27;;
import { PowerSchedulerService } from &#x27;./power_scheduler.service&#x27;;
import { DomainService } from &#x27;../domain/domain.service&#x27;;
import { DeviceTypeService } from &#x27;../device_type/device_type.service&#x27;;
import { DeviceDataService } from &#x27;../device_data/device_data.service&#x27;;
import { AppService } from &#x27;src/app.service&#x27;;
import { Util } from &#x27;src/util/util&#x27;;
import { AppConfigService } from &#x27;src/app_config.service&#x27;;
import { InfluxdbClientService } from &#x27;../device_data/influxdb_client.service&#x27;;
import { UserWithPermission } from &#x27;../user/user_with_permission.entity&#x27;;
import { DeviceService } from &#x27;../device/device.service&#x27;;
import { start } from &#x27;repl&#x27;;

var moment &#x3D; require(&#x27;moment-timezone&#x27;);
require(&#x27;moment/locale/zh-tw&#x27;);

const {InfluxDB, Point} &#x3D; require(&#x27;@influxdata/influxdb-client&#x27;)

var cron &#x3D; require(&#x27;node-cron&#x27;);

type PowerCron &#x3D; {
  start_time: number,
  stop_time: number,
  weeks:string,
  power:number
};

var cron_tasks &#x3D; []

@Injectable()
export class PowerSchedulerExService extends PowerSchedulerService {
  constructor(
    //@InjectRepository(PowerScheduler) public readonly powerSchedulerRepository: Repository&lt;PowerScheduler&gt;,
    @InjectRepository(PowerScheduler) public readonly powerSchedulerRepository: Repository&lt;PowerScheduler&gt;,
    public readonly appService: AppService,
    public readonly powerSchedulerService: PowerSchedulerService,
    public readonly domainServiceEx: DomainService,
    public readonly deviceTypeService: DeviceTypeService,
    public readonly deviceService: DeviceService,
    public readonly deviceExService: DeviceService,
    public readonly deviceDataService: DeviceDataService,
  ) {
    super(powerSchedulerRepository)
  }

  async onModuleInit() {
    //this.dispatch();
    var system_user:UserWithPermission &#x3D; AppConfigService.getSystemUser()
    this.updateCronTasks(system_user)
  }

  /*
  async dispatch_old(this_user:UserWithPermission) {
    try {
      var power_schedulers &#x3D; await this.powerSchedulerService.findAll(this_user)
      var device_types &#x3D; await this.deviceTypeService.findAll(this_user, {where:{device_type_name:&#x27;pomcube&#x27;}})
      if (device_types.length&#x3D;&#x3D;0) {
        return;
      }
      var device_type_id &#x3D; device_types[0].device_type_id
      for (var power_scheduler of power_schedulers) {
        try {
          if (power_scheduler.enabled &amp;&amp; power_scheduler.domain_id!&#x3D;null) {
            var crons:Array&lt;PowerCron&gt; &#x3D; JSON.parse(power_scheduler.crons)
            if (!Array.isArray(crons)) continue;

            var now &#x3D; moment().tz(&#x27;Asia/Taipei&#x27;)
            var today_sec &#x3D; now.hours() * 60 * 60 + now.minutes() * 60 + now.seconds()
            var cron &#x3D; null
            for (var c of crons) {
              if (today_sec&gt;&#x3D;c.start_time &amp;&amp; today_sec&lt;c.stop_time) {
                cron &#x3D; c
                break;
              }
            }

          //  var devices &#x3D; await this.domainServiceExEx.getAllDevices(this.deviceService, power_scheduler.domain_id, {device_type_id:device_type_id}, 1000000)
            var organization_id &#x3D; await this.domainServiceEx.getOrganizationId(power_scheduler.domain_id)
            var params &#x3D; {
              organization_id: organization_id,
              device_output_name: &#x27;pomcube_data&#x27;,
              domain_id: power_scheduler.domain_id,
              timezone: &#x27;Asia/Taipei&#x27;,
              //group_function: &#x27;sum&#x27;,
              start: &#x27;-30d&#x27;,
              //stop: &#x27;&#x27;,
              fields: &#x27;BatSoC,SolarPower,LoadPower,GridPower&#x27;,
              time_function: &#x27;last&#x27;,
              group_by: &#x27;DeviceName,_field&#x27;,
              //pivot_columns: &#x27;DeviceName&#x27;
              //pivot_columns: &#x27;_field&#x27;,
              //debug:true
            }

            var rows &#x3D; await this.deviceDataService.query(this_user, params)
            var device_datas &#x3D; {}
            for (var row of rows) {
              if (!(row.DeviceName in device_datas)) {
                device_datas[row.DeviceName] &#x3D; {}
              }
              device_datas[row.DeviceName][row._field] &#x3D; row._value
            }
          }
        } catch (ex) {
          console.log(ex)
        }
      }
    } catch (ex) {
      console.log(ex)
    }
  }
  */
  
  async notify(this_user:UserWithPermission, notify_user_id, text) {
    try {
      await this.appService.notifyUser(
        this_user,
        {
          user_id:notify_user_id,
          mail: true,
          email: true,
          line_notify: true
        },
        &#x27;power_scheduler&#x27;, text, null, null)
    } catch (ex) {
      console.log(ex);
    }
    
  }

  async writeInfluxdb(this_user:UserWithPermission, power_scheduler_id, domain_id, pstype, data, message&#x3D;&#x27;&#x27;, sell_energy&#x3D;null, purchase_energy&#x3D;null) {
    var organization_id &#x3D; await this.domainServiceEx.getOrganizationId(domain_id)
    var organization &#x3D; await this.domainServiceEx.findOne(this_user, organization_id)
    var org &#x3D; AppConfigService.getInfluxdbConfig().org;
    var power_scheduler_measurement &#x3D; AppConfigService.getSystemConfig().power_scheduler_measurement;
    var influxdb_client &#x3D; InfluxdbClientService.getClient();
    let writeClient &#x3D; influxdb_client.getWriteApi(org, organization.domain_name, &#x27;ms&#x27;)
    let point &#x3D; new Point(power_scheduler_measurement)
    point.tag(&#x27;power_scheduler_id&#x27;, power_scheduler_id)
    point.tag(&#x27;type&#x27;, pstype)
    point.stringField(&#x27;data&#x27;, &#x27;&#x27;+data)
    point.stringField(&#x27;message&#x27;, &#x27;&#x27;+message)
    if (sell_energy!&#x3D;null) {
      point.floatField(&#x27;sell_energy&#x27;, sell_energy)
    }
    if (purchase_energy!&#x3D;null) {
      point.floatField(&#x27;purchase_energy&#x27;, purchase_energy)
    }
    writeClient.writePoint(point)
    await writeClient.flush();
  }

  clearCronTask() {
    var power_scheduler_ids &#x3D; cron_tasks.map((cron_task)&#x3D;&gt;cron_task.power_scheduler_id)
    var power_scheduler_ids_set &#x3D; new Set(power_scheduler_ids)
    var power_scheduler_ids_array &#x3D; Array.from(power_scheduler_ids_set)
    if (power_scheduler_ids_array.length&gt;0) {
      console.log(&#x27;Cancel power_scheduler: &#x27; + JSON.stringify(power_scheduler_ids_array,null,4))
    }

    var size &#x3D; cron_tasks.length
    for (var n&#x3D;size-1; n&gt;&#x3D;0; n--) {
      var cron_task &#x3D; cron_tasks[n]
      cron_task.task.stop();
      cron_tasks.pop()
    }
  }


  async dispatch(this_user:UserWithPermission, cron_task) {
    var self &#x3D; this
    var device_types &#x3D; await self.deviceTypeService.findAll(this_user, {where:{device_type_name:&#x27;pomcube&#x27;}})
    if (device_types.length&#x3D;&#x3D;0) {
      return
    }
    var device_type_id &#x3D; device_types[0].device_type_id

    var power_scheduler &#x3D; await self.powerSchedulerService.findOne(this_user, cron_task.power_scheduler_id)
    if (power_scheduler&#x3D;&#x3D;null) throw new HttpException(&#x27;power_scheduler not found&#x27;, HttpStatus.NOT_FOUND);
    if (power_scheduler.domain_id!&#x3D;null &amp;&amp; power_scheduler.enabled) {
      var devices &#x3D; await self.domainServiceEx.getAllDevices(this_user, self.deviceService, power_scheduler.domain_id, {device_type_id:device_type_id}, 1000000)
      if (devices.length&#x3D;&#x3D;0) return;
      var power &#x3D; null
      if (cron_task.power!&#x3D;null) {
        power &#x3D; Math.floor(cron_task.power / devices.length)
        if (isNaN(power)) {
          throw new HttpException(&#x27;power is invalid&#x27;, HttpStatus.BAD_REQUEST)
        }
      }
      var has_error &#x3D; false
      var err_text &#x3D; &#x27;&#x27;
      for (var device of devices) {
        try {
          let data &#x3D; JSON.stringify({
            timezone: cron_task.timezone,
            continuity: cron_task.continuity,
            start_sec: cron_task.start_sec,
            stop_sec: cron_task.stop_sec,
            power: power
          })
          await self.deviceExService.sendDataToDevice(this_user, device.device_id, &#x27;pomcube_bat_power&#x27;, data)
          await Util.sleep(1000)
        } catch (ex) {
          has_error &#x3D; true
          err_text +&#x3D; ((ex.message!&#x3D;null)?ex.message:&#x27;&#x27;+ex) + &#x27;\n&#x27;;
          //console.log(ex)
        }
      }
      if (has_error) {
        throw new HttpException(err_text, HttpStatus.INTERNAL_SERVER_ERROR);
      }
      return
    }
    return
  }

  async getPomcubeData(this_user:UserWithPermission, domain_id) {
    var self &#x3D; this
    if (domain_id&#x3D;&#x3D;null) return [];
    var organization_id &#x3D; await self.domainServiceEx.getOrganizationId(domain_id)
    var params &#x3D; {
      organization_id: organization_id,
      device_output_name: &#x27;pomcube_data&#x27;,
      domain_id: domain_id,
      timezone: &#x27;Asia/Taipei&#x27;,
      //group_function: &#x27;sum&#x27;,
      start: &#x27;-30d&#x27;,
      //stop: &#x27;&#x27;,
      fields: &#x27;BatSoC,SolarPower,GridPower&#x27;,
      time_function: &#x27;last&#x27;,
      group_by: &#x27;DeviceName,_field&#x27;,
      //pivot_columns: &#x27;DeviceName&#x27;
      //pivot_columns: &#x27;_field&#x27;,
      //debug:true
    }

    var rows &#x3D; await self.deviceDataService.query(this_user, params)
    var device_datas &#x3D; {}
    for (var row of rows) {
      if (!(row.DeviceName in device_datas)) {
        device_datas[row.DeviceName] &#x3D; {}
      }
      device_datas[row.DeviceName][row._field] &#x3D; row._value
    }
    return device_datas
  }


  async startCronTask(this_user:UserWithPermission, cron_task, start_power) {
    var self &#x3D; this

    async function getEnergy(domain_id, start_time, stop_time) {
      var sell_energy &#x3D; null
      var purchase_energy &#x3D; null
      if (start_time!&#x3D;null &amp;&amp; stop_time!&#x3D;null) {
        var organization_id &#x3D; await self.domainServiceEx.getOrganizationId(domain_id)
        //var organization &#x3D; await self.domainService.findOne(organization_id)
        if (start_time!&#x3D;null &amp;&amp; stop_time!&#x3D;null) {
          let energys &#x3D; await self.deviceDataService.query(this_user, {
            &quot;organization_id&quot;: organization_id,
            &quot;device_output_name&quot;: &#x27;pomcube_data&#x27;,
            &quot;device_type_name&quot;: &quot;pomcube&quot;,
            &quot;domain_id&quot;: domain_id,
            &quot;start&quot;: start_time,
            &quot;stop&quot;: stop_time,
            &quot;fields&quot;: &#x27;GridSellEnergy,GridPurchaseEnergy&#x27;,
            &quot;differenceNonNegativeSource&quot;: true,
            &quot;group_by&quot;: &quot;!DeviceName,_field&quot;,
            &quot;timezone&quot;: &#x27;Asia/Taipei&#x27;,
            &quot;time_function&quot;: &quot;sum&quot;,
            &quot;group_function&quot;: &quot;sum&quot;,
            &quot;pivot_columns&quot;: &quot;_field&quot;
          })
          if (energys.length&gt;0) {
            sell_energy &#x3D; energys[0].GridSellEnergy
            purchase_energy &#x3D; energys[0].GridPurchaseEnergy
          }
        }
      }
      return {
        sell_energy,
        purchase_energy
      }
    }

    /*
    if (cron_task.executed) {
      console.log(&#x27;cron_task is executed.&#x27;, cron_task)
      return
    }
    */
    cron_task.executed &#x3D; true

    console.log((new Date()).toDateString() + &#x27; - PowerSchedulerExService start a cron_task.&#x27;);

    var system_user:UserWithPermission &#x3D; AppConfigService.getSystemUser()

    try {
      var power_scheduler &#x3D; await self.powerSchedulerService.findOne(system_user, cron_task.power_scheduler_id)
      if (power_scheduler&#x3D;&#x3D;null) return;
    } catch (ex) {
      console.log(ex)
      return
    }


    var sell_energy &#x3D; null
    var purchase_energy &#x3D; null
    var prev_start_sec &#x3D; cron_task.prev_start_sec
    var fire_sec &#x3D; cron_task.seconds
    if (prev_start_sec!&#x3D;null &amp;&amp; fire_sec!&#x3D;null) {
      try {
        var m &#x3D; moment.tz(new Date(), cron_task.timezone)
        m.startOf(&#x27;day&#x27;)
        let prev_start_time &#x3D; m.clone().add(prev_start_sec, &#x27;seconds&#x27;).toISOString()
        let fire_time &#x3D; m.clone().add(fire_sec, &#x27;seconds&#x27;).toISOString()
        var e &#x3D; await getEnergy(power_scheduler.domain_id, prev_start_time, fire_time)
        sell_energy &#x3D; e.sell_energy
        purchase_energy &#x3D; e.purchase_energy
      } catch (ex) {
        console.log(ex)
      }
    }

    try {

      var ex_dispatch &#x3D; null
      try {
        await this.dispatch(system_user, cron_task)
      } catch (ex) {
        ex_dispatch &#x3D; (ex.message!&#x3D;null)?ex.message:&#x27;&#x27;+ex;
        console.log(ex)
      }

      try {
        var text &#x3D; &#x27;&#x27;;
        var pstype &#x3D; &#x27;&#x27;
        //influx_data &#x3D; &#x60;{&quot;charge_power&quot;:${cron_task.power}}&#x60;
        var influx_data &#x3D; {&quot;charge_power&quot;:start_power}
        if (cron_task.start_stop&#x3D;&#x3D;&#x27;start&#x27;) {
          pstype &#x3D; &#x27;start&#x27;
          let text_dc &#x3D; &#x27;&#x27;
          if (cron_task.power&gt;0) {
            text_dc &#x3D; &#x27;充電&#x27;
          } else {
            text_dc &#x3D; &#x27;放電&#x27;
          }
          let power &#x3D; Math.abs(cron_task.power)
          //text &#x3D; &#x60;電池排程已啟動, 預定放電功率 ${-cron_task.power} w&#x60;
          text &#x3D; &#x60;電池排程已啟動, 預定${text_dc}功率 ${power} w&#x60;
          if (ex_dispatch!&#x3D;null) text +&#x3D; &#x27;\n&#x27; + ex_dispatch;
          try {
            await self.update(system_user, power_scheduler.power_scheduler_id, {
              &quot;running&quot;: true
            });
          } catch (ex) {
            console.log(ex)
          }
        } else {
          pstype &#x3D; &#x27;stop&#x27;
          text &#x3D; &#x60;電池排程已停止&#x60;
          if (ex_dispatch!&#x3D;null) text +&#x3D; &#x27;\n&#x27; + ex_dispatch;
          try {
            await self.update(system_user, power_scheduler.power_scheduler_id, {
              &quot;running&quot;: false
            });
          } catch (ex) {
            console.log(ex)
          }
        }

        if (ex_dispatch!&#x3D;null) {
          influx_data[&quot;error&quot;] &#x3D; ex_dispatch
        }
        try {
          await self.writeInfluxdb(system_user, power_scheduler.power_scheduler_id, power_scheduler.domain_id, pstype, JSON.stringify(influx_data), text, sell_energy, purchase_energy)
        } catch (ex) {
          console.log(ex)
        }
        await self.notify(this_user, cron_task.notify_user_id, text)
      } catch (ex) {
        console.log(ex)
      }

      await Util.sleep(240000)
      //await Util.sleep(60000)

      /*
      // GridPower: {正:充電, 負:放電}
      power_scheduler.info &#x3D; {
        &quot;start&quot;: {
          &quot;time&quot;: &quot;2024-11-17T02:00:00.000Z&quot;,
          &quot;error&quot;: &quot;device offline&quot;,
          &quot;devices&quot;: [
            {
              &quot;DeviceName&quot;: &quot;ESS01&quot;,
              &quot;SoC&quot;: 100,
              &quot;SolarPower&quot;: 996,
              &quot;GridPower&quot;: -700
            }
          ]
        },
        &quot;stop&quot;: {
          &quot;time&quot;: &quot;2024-11-17T04:00:00.000Z&quot;,
          &quot;error&quot;: null,
          &quot;devices&quot;: [
            {
              &quot;DeviceName&quot;: &quot;ESS01&quot;,
              &quot;SoC&quot;: 100,
              &quot;SolarPower&quot;: 996,
              &quot;GridPower&quot;: -700
            }
          ]
        }
      }
      */

      var device_datas &#x3D; {}
      try {
        device_datas &#x3D; await self.getPomcubeData(this_user, power_scheduler.domain_id)
        var device_infos &#x3D; []
        var text &#x3D; &#x27;目前裝置狀態\n&#x27;
        for (var device_data_name in device_datas) {
          var device_data &#x3D; device_datas[device_data_name]
          text +&#x3D; device_data_name + &#x27;\n&#x27;
          text +&#x3D; &#x27;  SoC : &#x27; + device_data.BatSoC + &#x27; %\n&#x27;
          text +&#x3D; &#x27;  SolarPower : &#x27; + device_data.SolarPower + &#x27; w\n&#x27;
          text +&#x3D; &#x27;  GridPower : &#x27; + device_data.GridPower + &#x27; w\n&#x27;
          device_infos.push({
            &quot;DeviceName&quot;: device_data_name,
            &quot;SoC&quot;: device_data.BatSoC,
            &quot;SolarPower&quot;: device_data.SolarPower,
            &quot;GridPower&quot;: device_data.GridPower
          })
        }

        var info:any &#x3D; {}
        var start_time &#x3D; null
        var stop_time &#x3D; null

        if (cron_task.start_stop&#x3D;&#x3D;&#x27;start&#x27;) {
          start_time &#x3D; (new Date()).toISOString()
          info &#x3D; {
            &quot;start&quot;: {
              &quot;time&quot;: start_time,
              &quot;error&quot;: ex_dispatch,
              &quot;devices&quot;: device_infos
            }
          }
        } else if (cron_task.start_stop&#x3D;&#x3D;&#x27;stop&#x27;) {
          info &#x3D; {}
          try {
            info &#x3D; JSON.parse(power_scheduler.info)
            let time &#x3D; power_scheduler.start_time
            if (time!&#x3D;null) {
              start_time &#x3D; (new Date(time)).toISOString()
            }
          } catch (ex) {
            console.log(ex)
          }
          stop_time &#x3D; (new Date()).toISOString()
          info.stop &#x3D; {
            &quot;time&quot;: stop_time,
            &quot;error&quot;: ex_dispatch,
            &quot;devices&quot;: device_infos
          }
        }

        info.sell_energy &#x3D; sell_energy
        info.purchase_energy &#x3D; purchase_energy

        /*
        var update_count &#x3D; power_scheduler.update_count
        var discharge_energy &#x3D; power_scheduler.discharge_energy
        if (cron_task.start_stop&#x3D;&#x3D;&#x27;stop&#x27;) {
          update_count ++
          if (sell_energy!&#x3D;null) discharge_energy +&#x3D; sell_energy
        }
        */
        
        try {
          var new_data:any &#x3D; {
            &quot;info&quot;: JSON.stringify(info)
          }
          if (cron_task.start_stop&#x3D;&#x3D;&#x27;start&#x27;) new_data.start_time &#x3D; start_time;
          if (cron_task.start_stop&#x3D;&#x3D;&#x27;stop&#x27;) new_data.stop_time &#x3D; stop_time;
          await self.update(system_user, power_scheduler.power_scheduler_id, new_data);
        } catch (ex) {
          console.log(ex)
        }

        try {
          var pstype:string &#x3D; (cron_task.start_stop&#x3D;&#x3D;&#x27;start&#x27;)?&#x27;start_stable&#x27;:&#x27;stop_stable&#x27;;
          if (Object.keys(device_datas).length&gt;0) {
            await self.writeInfluxdb(system_user, power_scheduler.power_scheduler_id, power_scheduler.domain_id, pstype, JSON.stringify(device_datas), text, sell_energy, purchase_energy)
          }
        } catch (ex) {
          console.log(ex)
        }

        await self.notify(this_user, cron_task.notify_user_id, text)
      } catch (ex) {
        console.log(ex)
      }
    } catch (ex) {
      console.log(ex)
    }
  }
  
  async startNowCronTask(this_user:UserWithPermission) {
    var now &#x3D; moment();
    for (var cron_task of cron_tasks) {
      if (cron_task.start_stop!&#x3D;&#x27;start&#x27;) continue;
      now.tz(cron_task.timezone)
      var start_of_day &#x3D; now.clone().startOf(&#x27;day&#x27;); // 今天 00:00:00
      var secondsPassed &#x3D; now.diff(start_of_day, &#x27;seconds&#x27;);
      if (cron_task.start_sec&lt;&#x3D;secondsPassed &amp;&amp; secondsPassed&lt;cron_task.stop_sec) {
        await this.startCronTask(this_user, cron_task, cron_task.start_power)
      }
    }
  }

  
  isCronTaskRunning() {
    var now &#x3D; moment();
    var running &#x3D; false
    for (var cron_task of cron_tasks) {
      if (cron_task.start_stop!&#x3D;&#x27;start&#x27;) continue;
      now.tz(cron_task.timezone)
      var start_of_day &#x3D; now.clone().startOf(&#x27;day&#x27;); // 今天 00:00:00
      var secondsPassed &#x3D; now.diff(start_of_day, &#x27;seconds&#x27;);
      if (cron_task.start_sec&lt;&#x3D;secondsPassed &amp;&amp; secondsPassed&lt;cron_task.stop_sec) {
        running &#x3D; true
        break
      }
    }
    return running
  }

  async updateCronTasks(this_user:UserWithPermission) {
    var self &#x3D; this

    var test_mode &#x3D; AppConfigService.getSystemConfig().test_mode
  //  if (test_mode) return;

    function addCronTask(power_scheduler_id, start_stop, continuity, timezone, prev_start_sec, start_sec, stop_sec, fire_sec, power, start_power, notify_user_id) {

      function CTask(cron_task) {
        var seconds &#x3D; cron_task.seconds
        const hours &#x3D; Math.floor(seconds / 3600) % 24;
        const minutes &#x3D; Math.floor((seconds % 3600) / 60);
        const secs &#x3D; seconds % 60;

        var cron_text &#x3D; &#x60;${secs} ${minutes} ${hours} * * *&#x60;
        var task &#x3D; cron.schedule(cron_text, async() &#x3D;&gt; {
          //console.log((new Date()).toDateString() + &#x27; - PowerSchedulerExService start a cron_task.&#x27;);

          var system_user:UserWithPermission &#x3D; AppConfigService.getSystemUser()
          //if (cron_task.start_stop&#x3D;&#x3D;&#x27;start&#x27;) {
          //  await this.startNowCronTask(system_user)
          //} else if (cron_task.start_stop&#x3D;&#x3D;&#x27;stop&#x27;) {
            await self.startCronTask(system_user, cron_task, start_power)
          //}
        }, {
          scheduled: true,
          timezone: cron_task.timezone
        });
        cron_task.task &#x3D; task
      }

      var cron_task &#x3D; {
        executed: false,
        power_scheduler_id,
        start_stop,
        timezone,
        continuity,
        prev_start_sec,
        start_sec,
        stop_sec,
        seconds: fire_sec,
        start_power,
        power,
        notify_user_id,
        task: null
      }

      new CTask(cron_task)
      cron_tasks.push(cron_task)
    }

    try {
      this.clearCronTask()
      var power_schedulers &#x3D; await this.powerSchedulerService.findAll(this_user)

      
      //console.log(JSON.stringify(power_schedulers,null,4))
      /*
      power_schedulers &#x3D; [
        {
            &quot;power_scheduler_id&quot;: 4,
            &quot;domain_id&quot;: 187,
            &quot;device_id&quot;: null,
            &quot;timezone&quot;: &quot;Asia/Taipei&quot;,
            &quot;crons&quot;: &quot;[{\&quot;start_time\&quot;:53880, \&quot;stop_time\&quot;:54280, \&quot;power\&quot;:-30000}, {\&quot;start_time\&quot;:3600, \&quot;stop_time\&quot;:10800, \&quot;power\&quot;:10000}]&quot;,
            &quot;notify_user_id&quot;: 1,
            &quot;update_time&quot;: &quot;2024-12-05T23:54:31.212Z&quot;,
            &quot;start_time&quot;: null,
            &quot;stop_time&quot;: null,
            &quot;running&quot;: false,
            &quot;info&quot;: &quot;&quot;,
            &quot;enabled&quot;: true
        }
      ]
      */
      


      /*
      var device_types &#x3D; await this.deviceTypeService.findAll({where:{device_type_name:&#x27;pomcube&#x27;}})
      if (device_types.length&#x3D;&#x3D;0) {
        return;
      }
      var device_type_id &#x3D; device_types[0].device_type_id
      */
      for (var power_scheduler of power_schedulers) {
        try {
          if (power_scheduler.enabled &amp;&amp; power_scheduler.domain_id!&#x3D;null) {

            console.log(JSON.stringify(power_scheduler,null,4))

            var crons:Array&lt;PowerCron&gt; &#x3D; JSON.parse(power_scheduler.crons)
            if (!Array.isArray(crons)) continue;

            crons.sort(function(a,b) {
              return a.start_time - b.start_time
            })

            var crons_size &#x3D; crons.length
            for (var n&#x3D;0; n&lt;crons_size; n++) {
              var c &#x3D; crons[n]
              if (c.start_time&lt;c.stop_time) {
                var continuity &#x3D; !(n&#x3D;&#x3D;crons_size-1 || crons[n+1].start_time!&#x3D;c.stop_time)

                var prev_start_sec &#x3D; null
                if (n&gt;0) {
                  if (crons[n-1].stop_time&#x3D;&#x3D;c.start_time) {
                    prev_start_sec &#x3D; crons[n-1].start_time
                  }
                }
                addCronTask(power_scheduler.power_scheduler_id, &#x27;start&#x27;, continuity, power_scheduler.timezone, prev_start_sec, c.start_time, c.stop_time, c.start_time, c.power, c.power, power_scheduler.notify_user_id)
                if (!continuity) {
                  prev_start_sec &#x3D; c.start_time
                  addCronTask(power_scheduler.power_scheduler_id, &#x27;stop&#x27;, continuity, power_scheduler.timezone, prev_start_sec, c.start_time, c.stop_time, c.stop_time, null, c.power, power_scheduler.notify_user_id)
                }
              }
            }
          }
        } catch (ex) {
          console.log(ex)
        }
      }
    } catch (ex) {
      console.log(ex)
    }

    try {
      await this.startNowCronTask(this_user)
    } catch (ex) {
      console.log(ex)
    }

  }

  async queryHistory(power_scheduler:PowerScheduler) {
    var params &#x3D; {
      organization_id: 182,
      device_output_name: &#x27;power_scheduler&#x27;,
      domain_id: 187,
      timezone: &#x27;Asia/Taipei&#x27;,
      //group_function: &#x27;sum&#x27;,
      start: &#x27;-30d&#x27;,
      //stop: &#x27;&#x27;,
      fields: &#x27;data,message,purchase_energy,sell_energy&#x27;,
      //pivot_columns: &#x27;DeviceName&#x27;
      //pivot_columns: &#x27;_field&#x27;,
      //debug:true
    }

    var start_time &#x3D; moment().tz(&#x27;Asia/Taipei&#x27;)
    start_time.startOf(&#x27;month&#x27;)

    var flux &#x3D; &#x60;
from(bucket: &quot;工研院綠能所&quot;)
  |&gt; range(start: ${start_time.toISOString()})
  |&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_measurement&quot;] &#x3D;&#x3D; &quot;power_scheduler&quot;)
  |&gt; filter(fn: (r) &#x3D;&gt; r[&quot;power_scheduler_id&quot;] &#x3D;&#x3D; &quot;${power_scheduler.power_scheduler_id}&quot;)
  |&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_field&quot;] &#x3D;&#x3D; &quot;data&quot; or r[&quot;_field&quot;] &#x3D;&#x3D; &quot;message&quot; or r[&quot;_field&quot;] &#x3D;&#x3D; &quot;purchase_energy&quot; or r[&quot;_field&quot;] &#x3D;&#x3D; &quot;sell_energy&quot;)
  |&gt; pivot(rowKey: [&quot;_time&quot;], columnKey: [&quot;_field&quot;], valueColumn: &quot;_value&quot;)
  |&gt; group()
  |&gt; sort(columns: [&quot;_time&quot;], desc: true)
  &#x60;

    var datas &#x3D; await this.deviceDataService.queryByFlux(flux)
    //datas.sort(function(a,b){
    //  return a._time - b._time
    //})
    return datas

    //  |&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_field&quot;] &#x3D;&#x3D; &quot;data&quot; or r[&quot;_field&quot;] &#x3D;&#x3D; &quot;message&quot; or r[&quot;_field&quot;] &#x3D;&#x3D; &quot;purchase_energy&quot; or r[&quot;_field&quot;] &#x3D;&#x3D; &quot;sell_energy&quot;)
  }

}

/*
async function xxx() {
  function x(v) {
    setTimeout(function() {
      console.log(&#x27;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &#x27; + v)
    }, Math.floor(Math.random()*10000))
  }

  for (var n&#x3D;0; n&lt;10; n++) {
    new x(n)
  }
}
xxx()
*/
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'PowerSchedulerExService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
