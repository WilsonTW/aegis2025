<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>aegis documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">aegis documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >DeviceReportService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/device_data/device_report.service.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#appService" >appService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceDataService" >deviceDataService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceOutputService" >deviceOutputService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceService" >deviceService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#deviceTypeService" >deviceTypeService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#domainService" >domainService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#domainServiceEx" >domainServiceEx</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#eventService" >eventService</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#influxdbClientService" >influxdbClientService</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#createCurtailmentChart" >createCurtailmentChart</a>
                            </li>
                            <li>
                                <a href="#createEnergyChart" >createEnergyChart</a>
                            </li>
                            <li>
                                <a href="#createPRChart" >createPRChart</a>
                            </li>
                            <li>
                                <a href="#createProductionIrradiationChart" >createProductionIrradiationChart</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#generateEssPDF" >generateEssPDF</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#generatePvPDF" >generatePvPDF</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getDomainFeedInTariff" >getDomainFeedInTariff</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getEssHermesIncome" >getEssHermesIncome</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getGenerateMoney" >getGenerateMoney</a>
                            </li>
                            <li>
                                <a href="#mergeTariff" >mergeTariff</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                    <span class="modifier">Async</span>
                                <a href="#sumPowerToEnergy" >sumPowerToEnergy</a>
                            </li>
                            <li>
                                <a href="#toEnShortMonthName" >toEnShortMonthName</a>
                            </li>
                            <li>
                                <a href="#toShortMonthNameByTimezone" >toShortMonthNameByTimezone</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(influxdbClientService: <a href="../injectables/InfluxdbClientService.html" target="_self">InfluxdbClientService</a>, domainService: <a href="../injectables/DomainService.html" target="_self">DomainService</a>, domainServiceEx: <a href="../injectables/DomainService.html" target="_self">DomainService</a>, deviceTypeService: <a href="../injectables/DeviceTypeService.html" target="_self">DeviceTypeService</a>, deviceService: <a href="../injectables/DeviceService.html" target="_self">DeviceService</a>, deviceOutputService: <a href="../injectables/DeviceOutputService.html" target="_self">DeviceOutputService</a>, eventService: <a href="../injectables/EventService.html" target="_self">EventService</a>, appService: <a href="../injectables/AppService.html" target="_self">AppService</a>, deviceDataService: <a href="../injectables/DeviceDataService.html" target="_self">DeviceDataService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="42" class="link-to-prism">src/modules/device_data/device_report.service.ts:42</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>influxdbClientService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/InfluxdbClientService.html" target="_self" >InfluxdbClientService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>domainService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>domainServiceEx</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceTypeService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceTypeService.html" target="_self" >DeviceTypeService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceService.html" target="_self" >DeviceService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceOutputService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceOutputService.html" target="_self" >DeviceOutputService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>eventService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/EventService.html" target="_self" >EventService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>appService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AppService.html" target="_self" >AppService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>deviceDataService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DeviceDataService.html" target="_self" >DeviceDataService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createCurtailmentChart"></a>
                    <span class="name">
                        <span ><b>createCurtailmentChart</b></span>
                        <a href="#createCurtailmentChart"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>createCurtailmentChart(labels, solar_energys, prediction_energys, curtailment_ratios)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="357"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:357</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>labels</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>solar_energys</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>prediction_energys</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>curtailment_ratios</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createEnergyChart"></a>
                    <span class="name">
                        <span ><b>createEnergyChart</b></span>
                        <a href="#createEnergyChart"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>createEnergyChart(labels, load_energys, solar_energys, grid_energys, socs, min, max)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="246"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:246</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>labels</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>load_energys</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>solar_energys</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>grid_energys</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>socs</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>min</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>max</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createPRChart"></a>
                    <span class="name">
                        <span ><b>createPRChart</b></span>
                        <a href="#createPRChart"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>createPRChart(labels, production_values, pr_values, pg_values, min, max)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="138"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:138</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>labels</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>production_values</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>pr_values</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>pg_values</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>min</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>max</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createProductionIrradiationChart"></a>
                    <span class="name">
                        <span ><b>createProductionIrradiationChart</b></span>
                        <a href="#createProductionIrradiationChart"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>createProductionIrradiationChart(labels, production_values, irradiation_values)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="60"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:60</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>labels</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>production_values</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>irradiation_values</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="generateEssPDF"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>generateEssPDF</b></span>
                        <a href="#generateEssPDF"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>generateEssPDF(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, time_type, domain_id, year: string | number, month: string | number, timezone: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, device_type_id: null, fake_data: string | boolean)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1056"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:1056</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>time_type</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>year</td>
                                            <td>
                                                        <code>string | number</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>month</td>
                                            <td>
                                                        <code>string | number</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>timezone</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>&#x27;Asia/Taipei&#x27;</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>device_type_id</td>
                                            <td>
                                                        <code>null</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>fake_data</td>
                                            <td>
                                                        <code>string | boolean</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>&#x27;false&#x27;</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Buffer&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="generatePvPDF"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>generatePvPDF</b></span>
                        <a href="#generatePvPDF"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>generatePvPDF(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, time_type, domain_id, year: string | number, month: string | number, timezone: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, device_type_id: null, fake_data: string | boolean)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="520"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:520</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>time_type</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>year</td>
                                            <td>
                                                        <code>string | number</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>month</td>
                                            <td>
                                                        <code>string | number</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>timezone</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>&#x27;Asia/Taipei&#x27;</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>device_type_id</td>
                                            <td>
                                                        <code>null</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>fake_data</td>
                                            <td>
                                                        <code>string | boolean</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>&#x27;false&#x27;</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Buffer&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getDomainFeedInTariff"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getDomainFeedInTariff</b></span>
                        <a href="#getDomainFeedInTariff"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getDomainFeedInTariff(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, domain_id)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1755"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:1755</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getEssHermesIncome"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getEssHermesIncome</b></span>
                        <a href="#getEssHermesIncome"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getEssHermesIncome(organization_name, devices, start_time, end_time)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1813"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:1813</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>organization_name</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>devices</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>start_time</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>end_time</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getGenerateMoney"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getGenerateMoney</b></span>
                        <a href="#getGenerateMoney"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getGenerateMoney(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, domain_id, device_type_id, start_time, end_time)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1835"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:1835</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>device_type_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>start_time</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>end_time</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mergeTariff"></a>
                    <span class="name">
                        <span ><b>mergeTariff</b></span>
                        <a href="#mergeTariff"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>mergeTariff(time_tariffs: Array<literal type>, start_time: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, end_time: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, tariff: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1688"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:1688</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>time_tariffs</td>
                                            <td>
                                                        <code>Array&lt;literal type&gt;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>start_time</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>end_time</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>tariff</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Array&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sumPowerToEnergy"></a>
                    <span class="name">
                            <span class="modifier">Static</span>
                            <span class="modifier">Async</span>
                        <span ><b>sumPowerToEnergy</b></span>
                        <a href="#sumPowerToEnergy"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>sumPowerToEnergy(this_user: <a href="../classes/UserWithPermission.html" target="_self">UserWithPermission</a>, domainServiceEx: <a href="../injectables/DomainService.html" target="_self">DomainService</a>, deviceService, deviceDataService, organization_name, domain_id, field_name, start_time, stop_time, timezone, every, device_type_id: null)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="478"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:478</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>this_user</td>
                                            <td>
                                                            <code><a href="../classes/UserWithPermission.html" target="_self" >UserWithPermission</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>domainServiceEx</td>
                                            <td>
                                                            <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>deviceService</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>deviceDataService</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>organization_name</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>domain_id</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>field_name</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>start_time</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>stop_time</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>timezone</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>every</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>device_type_id</td>
                                            <td>
                                                        <code>null</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>null</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="toEnShortMonthName"></a>
                    <span class="name">
                        <span ><b>toEnShortMonthName</b></span>
                        <a href="#toEnShortMonthName"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>toEnShortMonthName(month_number)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="457"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:457</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>month_number</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="toShortMonthNameByTimezone"></a>
                    <span class="name">
                        <span ><b>toShortMonthNameByTimezone</b></span>
                        <a href="#toShortMonthNameByTimezone"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>toShortMonthNameByTimezone(timezone, month_number)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="461"
                                    class="link-to-prism">src/modules/device_data/device_report.service.ts:461</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>timezone</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>month_number</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="appService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>appService</b></span>
                        <a href="#appService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/AppService.html" target="_self" >AppService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="53" class="link-to-prism">src/modules/device_data/device_report.service.ts:53</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceDataService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceDataService</b></span>
                        <a href="#deviceDataService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceDataService.html" target="_self" >DeviceDataService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="55" class="link-to-prism">src/modules/device_data/device_report.service.ts:55</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceOutputService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceOutputService</b></span>
                        <a href="#deviceOutputService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceOutputService.html" target="_self" >DeviceOutputService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="51" class="link-to-prism">src/modules/device_data/device_report.service.ts:51</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceService</b></span>
                        <a href="#deviceService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceService.html" target="_self" >DeviceService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="50" class="link-to-prism">src/modules/device_data/device_report.service.ts:50</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deviceTypeService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>deviceTypeService</b></span>
                        <a href="#deviceTypeService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DeviceTypeService.html" target="_self" >DeviceTypeService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="49" class="link-to-prism">src/modules/device_data/device_report.service.ts:49</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="domainService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>domainService</b></span>
                        <a href="#domainService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="47" class="link-to-prism">src/modules/device_data/device_report.service.ts:47</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="domainServiceEx"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>domainServiceEx</b></span>
                        <a href="#domainServiceEx"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/DomainService.html" target="_self" >DomainService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="48" class="link-to-prism">src/modules/device_data/device_report.service.ts:48</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="eventService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>eventService</b></span>
                        <a href="#eventService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/EventService.html" target="_self" >EventService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="52" class="link-to-prism">src/modules/device_data/device_report.service.ts:52</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="influxdbClientService"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>influxdbClientService</b></span>
                        <a href="#influxdbClientService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../injectables/InfluxdbClientService.html" target="_self" >InfluxdbClientService</a></code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="45" class="link-to-prism">src/modules/device_data/device_report.service.ts:45</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { HttpException, HttpStatus, Injectable, NotFoundException } from &#x27;@nestjs/common&#x27;;
import { InfluxdbClientService } from &#x27;./influxdb_client.service&#x27;;
import { DomainService } from &#x27;../domain/domain.service&#x27;;
import { DeviceTypeService } from &#x27;../device_type/device_type.service&#x27;;
import { DeviceService } from &#x27;../device/device.service&#x27;;
import { DeviceOutputService } from &#x27;../device_output/device_output.service&#x27;;
import { EventService } from &#x27;../event/event.service&#x27;;
import { AppService } from &#x27;src/app.service&#x27;;
import { Util } from &#x27;src/util/util&#x27;;
import { AppConfigService } from &#x27;src/app_config.service&#x27;;
import { DeviceDataService } from &#x27;./device_data.service&#x27;;
import { In, Repository } from &#x27;typeorm&#x27;;

import * as PDFDocument from &#x27;pdfkit&#x27;
import { width } from &#x27;pdfkit/js/page&#x27;;
import { every } from &#x27;rxjs&#x27;;
import { UserWithPermission } from &#x27;../user/user_with_permission.entity&#x27;;

const path &#x3D; require(&#x27;path&#x27;);

const { registerFont, createCanvas } &#x3D; require(&#x27;canvas&#x27;)

//const Chart &#x3D; require(&#x27;chart.js&#x27;);
const Chart &#x3D; require(&#x27;chart.js/auto&#x27;);
//import Chart from &#x27;chart.js/auto&#x27;;

const fs &#x3D; require(&#x27;fs&#x27;);
//import moment from &#x27;moment-timezone&#x27;;
var moment &#x3D; require(&#x27;moment-timezone&#x27;);
require(&#x27;moment/locale/zh-tw&#x27;);

const tmp &#x3D; require(&#x27;tmp&#x27;);
var AdmZip &#x3D; require(&quot;adm-zip&quot;);

//const font_path &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;font&#x27;, &#x27;Noto_Sans_TC&#x27;, &#x27;NotoSansTC-VariableFont_wght.ttf&#x27;)
const font_path_medium &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;font&#x27;, &#x27;Noto_Sans_TC&#x27;, &#x27;static&#x27;, &#x27;NotoSansTC-Medium.ttf&#x27;)
const font_path_regular &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;font&#x27;, &#x27;Noto_Sans_TC&#x27;, &#x27;static&#x27;, &#x27;NotoSansTC-Regular.ttf&#x27;)
registerFont(font_path_regular, {family: &#x27;Regular&#x27;});

@Injectable()
export class DeviceReportService {
  
  constructor(
    public readonly influxdbClientService:InfluxdbClientService,

    public readonly domainService: DomainService,
    public readonly domainServiceEx: DomainService,
    public readonly deviceTypeService: DeviceTypeService,
    public readonly deviceService: DeviceService,
    public readonly deviceOutputService: DeviceOutputService,
    public readonly eventService: EventService,
    public readonly appService: AppService,

    public readonly deviceDataService: DeviceDataService,
  ) {
  }


  createProductionIrradiationChart(labels, production_values, irradiation_values) {
    const width &#x3D; 1100;
    const height &#x3D; 500;
    const canvas &#x3D; createCanvas(width, height);
    const ctx &#x3D; canvas.getContext(&#x27;2d&#x27;);

    const data &#x3D; {
      labels: labels,
      datasets: [
        {
          label: &#x27;Production(kWh)&#x27;,
          data: production_values,
          borderColor: &quot;#8DE0C2&quot;,
          backgroundColor: &quot;#8DE0C2&quot;,
          yAxisID: &#x27;y&#x27;,
          order: 1
        },
        {
          label: &#x27;Irradiation(Wh/m2)&#x27;,
          data: irradiation_values,
          borderWidth: 4,
          borderColor: &quot;#00A2FF&quot;,
          backgroundColor: &quot;#00A2FF&quot;,
          yAxisID: &#x27;y1&#x27;,
          type: &#x27;line&#x27;,
          order: 0
        }
      ]
    };

    const config &#x3D; {
      type: &#x27;bar&#x27;,
      data: data,
      options: {
        responsive: true,
        interaction: {
          mode: &#x27;index&#x27;,
          intersect: false,
        },
        stacked: false,
        plugins: {
          title: {
            display: true,
            text: &#x27;Production(kWh) &amp; Irradiation(Wh/m2)&#x27;
          },
          legend: {
            display: true,
            position: &#x27;bottom&#x27;
          }
        },
        scales: {
          y: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;left&#x27;,
          },
          y1: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;right&#x27;,

            // grid line settings
            grid: {
              drawOnChartArea: false, // only want the grid lines for one axis to show up
            },
          },
        }
      },
    };

    const chart &#x3D; new Chart(ctx, config);

    // 将画布内容转换为 Base64 编码的 PNG 图像
    const base64Image &#x3D; canvas.toDataURL(&#x27;image/png&#x27;).split(&#x27;;base64,&#x27;)[1];
    return base64Image;
  }


  createPRChart(labels, production_values, pr_values, pg_values, min, max) {
    const width &#x3D; 1100;
    const height &#x3D; 500;
    const canvas &#x3D; createCanvas(width, height);
    const ctx &#x3D; canvas.getContext(&#x27;2d&#x27;);

    const data &#x3D; {
      labels: labels,
      datasets: [
        {
          label: &#x27;Production(kWh)&#x27;,
          data: production_values,
          borderColor: &quot;#8DE0C2&quot;,
          backgroundColor: &quot;#8DE0C2&quot;,
          yAxisID: &#x27;y&#x27;,
          order: 2
        },
        {
          label: &#x27;Performance Ratio(%)&#x27;,
          data: pr_values,
          borderWidth: 4,
          borderColor: &quot;#00A2FF&quot;,
          backgroundColor: &quot;#00A2FF&quot;,
          yAxisID: &#x27;y1&#x27;,
          type: &#x27;line&#x27;,
          order: 0
        },
        {
          label: &#x27;Performance Guarantee (%)&#x27;,
          data: pg_values,
          borderWidth: 4,
          borderColor: &quot;#FF644E&quot;,
          backgroundColor: &quot;#FF644E&quot;,
          yAxisID: &#x27;y2&#x27;,
          type: &#x27;line&#x27;,
          order: 1
        }
      ]
    };

    const config &#x3D; {
      type: &#x27;bar&#x27;,
      data: data,
      options: {
        responsive: true,
        interaction: {
          mode: &#x27;index&#x27;,
          intersect: false,
        },
        stacked: false,
        plugins: {
          title: {
            display: false,
            text: &#x27;&#x27;
          },
          legend: {
            display: true,
            position: &#x27;bottom&#x27;
          }
        },
        scales: {
          y: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;left&#x27;,
            title: {
              display: true,
              text: &#x27;kWh&#x27;
            }
          },
          y1: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;right&#x27;,
            // grid line settings
            grid: {
              drawOnChartArea: false, // only want the grid lines for one axis to show up
            },
            min: min,
            max: max,
            title: {
              display: true,
              text: &#x27;%&#x27;
            }
          },
          y2: {
            type: &#x27;linear&#x27;,
            display: false,
            position: &#x27;right&#x27;,
            // grid line settings
            grid: {
              drawOnChartArea: false, // only want the grid lines for one axis to show up
            },
            min: min,
            max: max,
          },
        }
      },
    };

    const chart &#x3D; new Chart(ctx, config);

    // 将画布内容转换为 Base64 编码的 PNG 图像
    const base64Image &#x3D; canvas.toDataURL(&#x27;image/png&#x27;).split(&#x27;;base64,&#x27;)[1];
    return base64Image;
  }


  createEnergyChart(labels, load_energys, solar_energys, grid_energys, socs, min, max) {
    const width &#x3D; 1100;
    const height &#x3D; 500;
    const canvas &#x3D; createCanvas(width, height);
    const ctx &#x3D; canvas.getContext(&#x27;2d&#x27;);

    const data &#x3D; {
      labels: labels,
      datasets: [
        {
          label: &#x27;Solar Energy(kWh)&#x27;,
          data: solar_energys,
          borderColor: &quot;#B6F0A7&quot;,
          backgroundColor: &quot;#B6F0A7&quot;,
          fill: true,
          yAxisID: &#x27;y&#x27;,
          type: &#x27;bar&#x27;,
          order: 2
        },
        {
          label: &#x27;Load Energy(kWh)&#x27;,
          data: load_energys,
          borderWidth: 4,
          borderColor: &quot;#F3BCB8&quot;,
          backgroundColor: &quot;#F3BCB8&quot;,
          fill: true,
          yAxisID: &#x27;y&#x27;,
          type: &#x27;bar&#x27;,
          order: 3
        },
        {
          label: &#x27;Grid Energys(kWh)&#x27;,
          data: grid_energys,
          borderWidth: 4,
          borderColor: &quot;#CED0D5&quot;,
          backgroundColor: &quot;#CED0D5&quot;,
          fill: true,
          yAxisID: &#x27;y&#x27;,
          type: &#x27;bar&#x27;,
          order: 4
        },
        {
          label: &#x27;SoC(%)&#x27;,
          data: socs,
          borderWidth: 4,
          borderColor: &quot;#4073D7&quot;,
          backgroundColor: &quot;#4073D7&quot;,
          yAxisID: &#x27;y1&#x27;,
          type: &#x27;line&#x27;,
          order: 1
        }
      ]
    };

    const config &#x3D; {
      type: &#x27;line&#x27;,
      data: data,
      options: {
        responsive: true,
        interaction: {
          mode: &#x27;index&#x27;,
          intersect: false,
        },
        stacked: false,
        plugins: {
          title: {
            display: false,
            text: &#x27;&#x27;
          },
          legend: {
            display: true,
            position: &#x27;bottom&#x27;
          }
        },
        scales: {
          y: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;left&#x27;,
            title: {
              display: true,
              text: &#x27;kWh&#x27;
            }
          },
          y1: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;right&#x27;,
            // grid line settings
            grid: {
              drawOnChartArea: false, // only want the grid lines for one axis to show up
            },
            min: min,
            max: max,
            title: {
              display: true,
              text: &#x27;%&#x27;
            }
          },
        }
      },
    };

    const chart &#x3D; new Chart(ctx, config);

    // 将画布内容转换为 Base64 编码的 PNG 图像
    const base64Image &#x3D; canvas.toDataURL(&#x27;image/png&#x27;).split(&#x27;;base64,&#x27;)[1];
    return base64Image;
  }


  createCurtailmentChart(labels, solar_energys, prediction_energys, curtailment_ratios) {
    const width &#x3D; 1100;
    const height &#x3D; 500;
    const canvas &#x3D; createCanvas(width, height);
    const ctx &#x3D; canvas.getContext(&#x27;2d&#x27;);

    const data &#x3D; {
      labels: labels,
      datasets: [
        {
          label: &#x27;Solar Energy(kWh)&#x27;,
          data: solar_energys,
          borderColor: &quot;#B6F0A7&quot;,
          backgroundColor: &quot;#B6F0A7&quot;,
          fill: true,
          yAxisID: &#x27;y&#x27;,
          type: &#x27;bar&#x27;,
          order: 2
        },
        {
          label: &#x27;Prediction Energy(kWh)&#x27;,
          data: prediction_energys,
          borderWidth: 4,
          borderColor: &quot;#91B889&quot;,
          backgroundColor: &quot;#91B889&quot;,
          fill: true,
          yAxisID: &#x27;y&#x27;,
          type: &#x27;bar&#x27;,
          order: 3
        },
        {
          label: &#x27;Curtailment Ratios(%)&#x27;,
          data: curtailment_ratios,
          borderWidth: 4,
          borderColor: &quot;#4073D7&quot;,
          backgroundColor: &quot;#4073D7&quot;,
          yAxisID: &#x27;y1&#x27;,
          type: &#x27;line&#x27;,
          order: 1
        }
      ]
    };

    const config &#x3D; {
      type: &#x27;line&#x27;,
      data: data,
      options: {
        responsive: true,
        interaction: {
          mode: &#x27;index&#x27;,
          intersect: false,
        },
        stacked: false,
        plugins: {
          title: {
            display: false,
            text: &#x27;&#x27;
          },
          legend: {
            display: true,
            position: &#x27;bottom&#x27;
          }
        },
        scales: {
          y: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;left&#x27;,
            title: {
              display: true,
              text: &#x27;kWh&#x27;
            }
          },
          y1: {
            type: &#x27;linear&#x27;,
            display: true,
            position: &#x27;right&#x27;,
            // grid line settings
            grid: {
              drawOnChartArea: false, // only want the grid lines for one axis to show up
            },
            min: 0,
            max: 100,
            title: {
              display: true,
              text: &#x27;%&#x27;
            }
          },
        }
      },
    };

    const chart &#x3D; new Chart(ctx, config);

    // 将画布内容转换为 Base64 编码的 PNG 图像
    const base64Image &#x3D; canvas.toDataURL(&#x27;image/png&#x27;).split(&#x27;;base64,&#x27;)[1];
    return base64Image;
  }


  toEnShortMonthName(month_number) {
    return moment().locale(&#x27;en&#x27;).month(month_number).format(&#x27;MMM&#x27;)
  }

  toShortMonthNameByTimezone(timezone, month_number) {
    // 建立一個在指定時區的時間
    const date &#x3D; moment.tz({ year: 2023, month: month_number, day: 1 }, timezone);
    // 根據時區選擇適當的月份格式
    if (timezone &#x3D;&#x3D;&#x3D; &#x27;Asia/Taipei&#x27;) {
        // 設置 locale 為中文繁體
        date.locale(&#x27;zh-tw&#x27;);
        return date.format(&#x27;MMM&#x27;); // 返回中文月份簡稱
    } else {
        // 設置 locale 為預設的英文
        date.locale(&#x27;en&#x27;);
        return date.format(&#x27;MMM&#x27;); // 返回英文月份簡稱
    }
  }



  static async sumPowerToEnergy(this_user:UserWithPermission, domainServiceEx:DomainService, deviceService, deviceDataService, organization_name, domain_id, field_name, start_time, stop_time, timezone, every, device_type_id&#x3D;null) {
    var args &#x3D; (device_type_id&#x3D;&#x3D;null || (&#x27;&#x27;+device_type_id).trim()&#x3D;&#x3D;&#x27;&#x27;) ? {} : {device_type_id: device_type_id}
    var device_names &#x3D; [];
    var devices &#x3D; await domainServiceEx.getAllDevices(this_user, deviceService, domain_id, args, 1000000);
    for (var device of devices) {
      //device_names.push(device.device_name)
      device_names.push(&#x60;r[&quot;${AppConfigService.DEVICE_NAME_FIELD}&quot;]&#x3D;&#x3D;&quot;${device.device_name}&quot;&#x60;)
    }

    var device_names_str &#x3D; device_names.join(&#x27; or &#x27;);

    var fluxQuery &#x3D; &#x27;&#x27;;
    if (timezone!&#x3D;null) {
      if (/[^a-zA-Z0-9\/]/.test(timezone)) {
        throw new HttpException(&#x27;&quot;timezone&quot; is invalid&#x27;, HttpStatus.BAD_REQUEST);
      }
      fluxQuery +&#x3D; &#x60;import &quot;timezone&quot;\n&#x60;;
      fluxQuery +&#x3D; &#x60;option location &#x3D; timezone.location(name: &quot;${timezone}&quot;)\n&#x60;;
    }
    fluxQuery +&#x3D; &#x60;
from(bucket: &quot;${organization_name}&quot;)
|&gt; range(start: ${start_time}, stop: ${stop_time})
|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_measurement&quot;] &#x3D;&#x3D; &quot;hermes_report&quot;)
|&gt; filter(fn: (r) &#x3D;&gt; ${device_names_str})
|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_field&quot;] &#x3D;&#x3D; &quot;${field_name}&quot;)
|&gt; sort(columns: [&quot;_time&quot;])
|&gt; map(fn: (r) &#x3D;&gt; ({ r with _timeInt: uint(v: r._time) }))
|&gt; difference(columns: [&quot;_timeInt&quot;])
|&gt; map(fn: (r) &#x3D;&gt; ({
_time: r._time,
_value: if exists r._timeInt then float(v: r._timeInt/1000000000) * r._value / (60.0*60.0) else 0.0
}))
&#x60;
    if (timezone!&#x3D;null) {
      fluxQuery +&#x3D; &#x60;|&gt; aggregateWindow(every: ${every}, fn: sum, createEmpty: true, location: location)&#x60;
    } else {
      fluxQuery +&#x3D; &#x60;|&gt; aggregateWindow(every: ${every}, fn: sum, createEmpty: true)&#x60;
    }
    return await deviceDataService.queryByFlux(fluxQuery);
  }


  async generatePvPDF(this_user:UserWithPermission, time_type, domain_id, year:string|number, month:string|number&#x3D;null, timezone&#x3D;&#x27;Asia/Taipei&#x27;, device_type_id&#x3D;null, fake_data:string|boolean&#x3D;&#x27;false&#x27;): Promise&lt;Buffer&gt; {
    var guarantee_capacity &#x3D; 80;
    var device_type_name &#x3D; &#x27;pv_inverter&#x27;;
    var self &#x3D; this;
    var deviceDataService &#x3D; this.deviceDataService;
    const pdfBuffer: Buffer &#x3D; await new Promise(async (resolve, reject) &#x3D;&gt; {
      try {

        if (!(time_type&#x3D;&#x3D;&#x27;year&#x27; || time_type&#x3D;&#x3D;&#x27;month&#x27;)) {
          throw new HttpException(&#x27;time_type is must in {&quot;year&quot;, &quot;month&quot;}&#x27;, HttpStatus.BAD_REQUEST);
        }

        if (domain_id&#x3D;&#x3D;null || domain_id.trim()&#x3D;&#x3D;&#x27;&#x27; || isNaN(parseInt(domain_id))) {
          throw new HttpException(&#x27;domain_id is needed&#x27;, HttpStatus.BAD_REQUEST);
        }

        if (year&#x3D;&#x3D;null || (&#x27;&#x27;+year).trim()&#x3D;&#x3D;&#x27;&#x27; || (typeof(year)&#x3D;&#x3D;&#x27;string&#x27; &amp;&amp; isNaN(parseInt(year)))) {
          throw new HttpException(&#x27;year is needed&#x27;, HttpStatus.BAD_REQUEST);
        }
        year &#x3D; parseInt(&#x27;&#x27;+year);

        if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
          if (month&#x3D;&#x3D;null || (&#x27;&#x27;+month).trim()&#x3D;&#x3D;&#x27;&#x27; || (typeof(month)&#x3D;&#x3D;&#x27;string&#x27; &amp;&amp; isNaN(parseInt(month)))) {
            throw new HttpException(&#x27;month is invalid&#x27;, HttpStatus.BAD_REQUEST);
          }
          month &#x3D; parseInt(&#x27;&#x27;+month);
          if (month&lt;0 || month&gt;11) {
            throw new HttpException(&#x27;month is invalid. must be 0~11&#x27;, HttpStatus.BAD_REQUEST);
          }
        } else {
          month &#x3D; 0;
        }

        fake_data &#x3D; (fake_data&#x3D;&#x3D;&#x27;true&#x27; || fake_data&#x3D;&#x3D;&#x27;1&#x27;)

        if (timezone&#x3D;&#x3D;null) timezone&#x3D;&#x27;Asia/Taipei&#x27;
        if (/[^a-zA-Z0-9\/]/.test(timezone)) {
          throw new HttpException(&#x27;&quot;timezone&quot; is invalid&#x27;, HttpStatus.BAD_REQUEST);
        }

        var data_count &#x3D; 30;
        if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
          data_count &#x3D; 12;
        } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
          var m &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
          if (!m.isValid()) {
            throw new HttpException(&#x27;Invalid date.&#x27;, HttpStatus.BAD_REQUEST);
          }
          data_count &#x3D; m.daysInMonth();
        }

        var domain &#x3D; await this.domainService.findOne(this_user, domain_id);
        if (domain&#x3D;&#x3D;null) {
          throw new HttpException(&#x27;Domain not found.&#x27;, HttpStatus.NOT_FOUND);
        }

        var organization_id &#x3D; await this.domainService.getOrganizationId(domain_id);
        if (organization_id&#x3D;&#x3D;null) {
          throw new HttpException(&#x27;Organization of Domain not found.&#x27;, HttpStatus.NOT_FOUND);
        }
        var organization &#x3D; await this.domainService.findOne(this_user, organization_id);
        if (organization?.domain_name&#x3D;&#x3D;null || organization.domain_name.trim()&#x3D;&#x3D;&#x27;&#x27;) {
          throw new HttpException(&#x27;Organization name not found.&#x27;, HttpStatus.NOT_FOUND);
        }
        var organization_name &#x3D; organization.domain_name.trim()

        var device_types &#x3D; await this.deviceTypeService.findAll(this_user, {where:{device_type_name:device_type_name}})
        if (device_types.length&#x3D;&#x3D;0) {
          throw new HttpException(&#x27;Device type(&#x27;+device_type_name+&#x27;) not found.&#x27;, HttpStatus.NOT_FOUND);
        }
        var device_type &#x3D; device_types[0]

        var args &#x3D; (device_type_id&#x3D;&#x3D;null || (&#x27;&#x27;+device_type_id).trim()&#x3D;&#x3D;&#x27;&#x27;) ? {} : {device_type_id: device_type_id}
        var devices &#x3D; await self.domainServiceEx.getAllDevices(this_user, self.deviceService, domain_id, args, 1000000);
        var capacity &#x3D; 0;
        for (var device of devices) {
          capacity +&#x3D; (device.solar_capacity&#x3D;&#x3D;null)?0:device.solar_capacity
        }

        var params_base &#x3D; {
          organization_id: organization_id,
          device_type_name: device_type_name,
          device_output_name: &#x27;hermes_report&#x27;,
          domain_id: domain_id,
          timezone: timezone,
          group_function: &#x27;sum&#x27;
        }

        async function getIntegrity(year:number, month:number) {
          var rets &#x3D; [];
          var datas:any &#x3D; [];
          var params_base2 &#x3D; Object.assign({fields: &#x27;SolarEnergy,Irradiance&#x27;}, params_base)
          var params &#x3D; {}
          var m_start;
          if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
            m_start &#x3D; moment.tz({ year: year, month: 0, day: 1 }, timezone);
            //var m_stop &#x3D; moment.tz({ year: year, month: 12, day: 31, hour:23, minute:59, second:59}, timezone);
            var m_stop &#x3D; moment.tz({ year: year+1, month: 0, day: 1 }, timezone);
            Object.assign(params, params_base2)
            Object.assign(params, {
              start: m_start.toISOString(),
              stop: m_stop.toISOString(),
              time_function: &#x27;count&#x27;,
              every: &#x27;1d&#x27;,
              create_empty: true,
              group_by: &#x27;_field&#x27;,
              group_function: &#x27;sum&#x27;,
              pivot_columns: &#x27;_field&#x27;
            })
            datas &#x3D; await deviceDataService.query(this_user, params);
            for (var n&#x3D;0; n&lt;12; n++) {
              rets.push({count:0, ok:0})
            }
            for (var data of datas) {
              let m &#x3D; moment.tz(data._time, timezone);
              var mo &#x3D; m.month()
              rets[mo].count ++;
              if (data.SolarEnergy&gt;0 &amp;&amp; data.Irradiance&gt;0) {
                rets[mo].ok ++;
              }
            }
          } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
            m_start &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
            var daysInMonth &#x3D; m_start.daysInMonth()
            //var m_stop &#x3D; moment.tz({ year: year, month: 12, day: 31, hour:23, minute:59, second:59}, timezone);
            var m_stop &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
            m_stop.add(1, &#x27;months&#x27;)
            Object.assign(params, params_base2)
            Object.assign(params, {
              start: m_start.toISOString(),
              stop: m_stop.toISOString(),
              time_function: &#x27;count&#x27;,
              every: &#x27;1h&#x27;,
              create_empty: true,
              group_by: &#x27;_field&#x27;,
              group_function: &#x27;sum&#x27;,
              pivot_columns: &#x27;_field&#x27;
            })
            datas &#x3D; await deviceDataService.query(this_user, params);
            for (var n&#x3D;0; n&lt;daysInMonth; n++) { // rets[0] is the first day of month
              rets.push({count:0, ok:0})
            }
            for (var data of datas) {
              let m &#x3D; moment.tz(data._time, timezone);
              var d &#x3D; m.date() - 1
              rets[d].count ++;
              if (data.SolarEnergy&gt;0 &amp;&amp; data.Irradiance&gt;0) {
                rets[d].ok ++;
              }
            }
          }
          return rets
        }

        /*
        async function getDiffEnergy(field_name, year:number, month:number) {
          var datas:any &#x3D; [];
          var params_base2 &#x3D; Object.assign({fields: field_name}, params_base)
          var params &#x3D; {}
          var m_start;
          if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
            m_start &#x3D; moment.tz({ year: year, month: 0, day: 1 }, timezone);
            m_start.subtract(1, &#x27;months&#x27;)
            //var m_stop &#x3D; moment.tz({ year: year, month: 12, day: 31, hour:23, minute:59, second:59}, timezone);
            var m_stop &#x3D; moment.tz({ year: year+1, month: 0, day: 1 }, timezone);
            Object.assign(params, params_base2)
            Object.assign(params, {
              start: m_start.toISOString(),
              stop: m_stop.toISOString(),
              time_function: &#x27;last&#x27;,
              every: &#x27;1mo&#x27;,
              create_empty: true
            })
            datas &#x3D; await deviceDataService.query(params);
          } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
            m_start &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
            m_start.subtract(1, &#x27;days&#x27;)
            //var m_stop &#x3D; moment.tz({ year: year, month: 12, day: 31, hour:23, minute:59, second:59}, timezone);
            var m_stop &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
            m_stop.add(1, &#x27;months&#x27;)
            Object.assign(params, params_base2)
            Object.assign(params, {
              start: m_start.toISOString(),
              stop: m_stop.toISOString(),
              time_function: &#x27;last&#x27;,
              every: &#x27;1d&#x27;,
              create_empty: true
            })
            datas &#x3D; await deviceDataService.query(params);
          }

          if (datas.length&gt;0 &amp;&amp; datas[0]._value&#x3D;&#x3D;null) {
            var param_first &#x3D; Object.assign({}, params_base2)
            Object.assign(param_first, {
              start: 0,
              stop: m_stop.toISOString(),
              time_function: &#x27;first&#x27;
            })
            var datas2:any &#x3D; await deviceDataService.query(param_first);
            if (datas2.length&gt;0) {
              var v &#x3D; datas2[0]._value
              for (var n&#x3D;0; n&lt;datas.length-1; n++) {
                if (datas[n]._value&#x3D;&#x3D;null &amp;&amp; datas[n+1]._value!&#x3D;null) {
                  datas[n]._value &#x3D; v
                  break;
                }
              }
            }
          }

          for (var n&#x3D;0; n&lt;datas.length; n++) {
            datas[n]._diff &#x3D; (n&#x3D;&#x3D;0||datas[n]._value&#x3D;&#x3D;null||datas[n-1]._value&#x3D;&#x3D;null)?null:datas[n]._value-datas[n-1]._value
          }
          if (datas.length&gt;0) datas.shift();
          return datas;
        }
        */


        var prs &#x3D; null;
        var solar_energy_datas:any &#x3D; [];
        var irradiance_datas:any &#x3D; [];
        var integrity_datas:any &#x3D; [];
        var m_start;
        var m_stop;
        if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
          m_start &#x3D; moment.tz({ year: year, month: 0, day: 1 }, timezone);
          //m_start.subtract(1, &#x27;months&#x27;)
          m_stop &#x3D; moment.tz({ year: year+1, month: 0, day: 1 }, timezone);
        } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
          m_start &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
          //m_start.subtract(1, &#x27;days&#x27;)
          m_stop &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
          m_stop.add(1, &#x27;months&#x27;)
        }
        if (!fake_data) {
          var params2 &#x3D; {
            organization_id: organization_id,
            domain_id: domain_id,
            start: m_start.toISOString(),
            stop: m_stop.toISOString(),
            every: &#x27;1d&#x27;,
            timezone: timezone
          }
          if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
            params2[&#x27;every&#x27;] &#x3D; &#x27;1mo&#x27;
          } else {
            params2[&#x27;every&#x27;] &#x3D; &#x27;1d&#x27;
          }
          prs &#x3D; await this.deviceDataService.getPR(this_user, params2);
          integrity_datas &#x3D; await getIntegrity(year, month)

          /*
          solar_energy_datas &#x3D; await getDiffEnergy(&#x27;SolarEnergy&#x27;, year, month)
          let every &#x3D; (time_type&#x3D;&#x3D;&#x27;month&#x27;)?&#x27;1d&#x27;:&#x27;1mo&#x27;
          irradiance_datas &#x3D; await DeviceReportService.sumPowerToEnergy(
            self.domainService, self.deviceService, self.deviceDataService,
            organization_name, domain_id, &#x27;Irradiance&#x27;, m_start.toISOString(), m_stop.toISOString(),
            timezone, every, device_type_id)
          integrity_datas &#x3D; await getIntegrity(year, month)
          */
        }

        //var size &#x3D; 30;
        var labels &#x3D; [];
        var production_values &#x3D; [];
        var irradiation_values &#x3D; [];
        var production_sum &#x3D; 0;
        var irradiation_sum &#x3D; 0;
        var pr_values &#x3D; [];
        var pg_values &#x3D; [];
        var data_integrity_values &#x3D; [];
        for (var n&#x3D;0; n&lt;data_count; n++) {
          var label &#x3D; &#x27;&#x27;+(n+1);
          if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
            var m &#x3D; moment.tz({ year: 2023, month: n, day: 1 }, timezone);
            m.locale(&#x27;en&#x27;);
            label &#x3D; m.format(&#x27;MMM&#x27;);
          }
          labels.push(label);
          if (fake_data) {
            production_values.push(Math.floor(Math.random()*6000));
            irradiation_values.push(Math.floor(Math.random()*900));
            pr_values.push(70+Math.floor(Math.random()*20));
            data_integrity_values.push(95+Math.floor(Math.random()*5));
          } else {
            /*
            var solar_energy_data_diff &#x3D; (solar_energy_datas[n]?._diff&#x3D;&#x3D;null) ? null : Math.floor(solar_energy_datas[n]._diff)
            var irradiance_data_value &#x3D; (irradiance_datas&#x3D;&#x3D;null || irradiance_datas[n]?._value&#x3D;&#x3D;null) ? null : Math.floor(irradiance_datas[n]._value)
            production_values.push(solar_energy_data_diff);
            irradiation_values.push(irradiance_data_value);
            var pr &#x3D; null;
            if (solar_energy_data_diff!&#x3D;null &amp;&amp; irradiance_data_value!&#x3D;null) {
              var production_yield &#x3D; solar_energy_data_diff / capacity;
              var irradiation_yield &#x3D; irradiance_data_value / 1000;
              pr &#x3D; (irradiation_yield&#x3D;&#x3D;0) ? null : production_yield / irradiation_yield * 100
            }
            pr_values.push(pr);
            */
            production_values.push(prs[n]?.SolarEnergy);
            irradiation_values.push(prs[n]?.Irradiance);
            pr_values.push(prs[n]?.PR);
            data_integrity_values.push(integrity_datas[n].ok/integrity_datas[n].count);
          }
          pg_values.push(guarantee_capacity);
          //data_integrity_values.push(95+Math.floor(Math.random()*5));
          //data_integrity_values.push(null);
          if (production_values[n]!&#x3D;null) {
            production_sum +&#x3D; production_values[n]
          }
          if (irradiation_values[n]!&#x3D;null) {
            irradiation_sum +&#x3D; irradiation_values[n]
          }
        }
        //var pr_total &#x3D; (production_sum/capacity) / (irradiation_sum/1000) * 100
        var pr_total &#x3D; Util.avg(pr_values)


        var fit_rate_str &#x3D; &#x27;&#x27;;
        var plant_income &#x3D; 0;
        if (fake_data) {
          capacity &#x3D; 196
          production_sum &#x3D; 20416
          irradiation_sum &#x3D; 130835
          pr_total &#x3D; 79.65
          fit_rate_str &#x3D; &#x27;4.1733&#x27;;
          plant_income &#x3D; 85202.09;
        } else {
          var generate_money &#x3D; await this.getGenerateMoney(this_user, domain_id, device_type.device_type_id, m_start.toISOString(), m_stop.toISOString())
          var tariffs &#x3D; [];
          for (var income of generate_money.incomes) {
            if (income.tariff!&#x3D;null &amp;&amp; tariffs.indexOf(income.tariff)&#x3D;&#x3D;-1) tariffs.push(income.tariff)
          }
          var fit_rate_str &#x3D; tariffs.join(&#x27;, &#x27;);
          plant_income &#x3D; generate_money.total_income
        }

        const doc &#x3D; new PDFDocument({
          size: &#x27;A4&#x27;, // A4 (595.28 x 841.89)
          bufferPages: true,
        })

        doc.font(font_path_regular)
        //doc.font(font_path, &#x27;Regular&#x27;)

        const page_width &#x3D; 595;
        const page_height &#x3D; 841;
        const page_lr_margin &#x3D; 20;

  /*
        doc.addPage({
          margins: {
            top: 50,
            bottom: 50,
            left: 50,
            right: 50
          }
        });
  */

        const header_top &#x3D; 50;
        const header_height &#x3D; 40;
        const header_bottom &#x3D; header_top+header_height;


        var logo_path &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;derui.png&#x27;)
        doc.image(logo_path, page_width-page_lr_margin-100, 15, {
          fit: [100, 24],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });
        
        doc.lineWidth(1);
        doc.rect(page_lr_margin, header_top, page_width-page_lr_margin*2, 150);
        doc.stroke(&quot;#CCCCCC&quot;);

        doc.rect(page_lr_margin, header_top, page_width-page_lr_margin*2, header_height);
        //doc.fillAndStroke(&quot;#000&quot;, &quot;#900&quot;)
        doc.fill(&quot;#093040&quot;)

        var logo_path2 &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;aegis.png&#x27;)
        const logo2_height &#x3D; 20;
        doc.image(logo_path2, page_lr_margin+10, header_top+(header_height-logo2_height)/2, {
          fit: [73, logo2_height],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });

        var report_range_name &#x3D; (time_type&#x3D;&#x3D;&#x27;year&#x27;)?&#x27;Year&#x27;:&#x27;Monthly&#x27;
        var report_time &#x3D; (time_type&#x3D;&#x3D;&#x27;year&#x27;)?year:self.toEnShortMonthName(month)+&#x27;/&#x27;+year
        
      //  doc.font(font_path, &#x27;Bold&#x27;)
        doc.fontSize(12)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        doc.text(&#x60;${domain.domain_name} ${report_range_name} Report - ${report_time}&#x60;, 0, header_top+10, {width: page_width, align: &#x27;center&#x27;});
        doc.text(&#x60;${Util.numberWithCommas(capacity)} kWp&#x60;, 0, header_top+10, {width: page_width-page_lr_margin-50, align: &#x27;right&#x27;});

        const header_column_width1 &#x3D; 150
        const header_column_width2 &#x3D; 170
        const header_column_height &#x3D; 30
        const header_column_pad_top &#x3D; 15
        const header_column_pad_left &#x3D; 10
        const header_value_left1 &#x3D; page_lr_margin+header_column_width1+header_column_pad_left
        const header_value_left2 &#x3D; page_lr_margin+header_column_width2+header_column_pad_left+280

      //  doc.font(font_path, &#x27;Medium&#x27;)
        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        doc.text(&#x60;Production (kWh):&#x60;, page_lr_margin+10, header_bottom+header_column_pad_top+header_column_height*0, {width: header_column_width1, align: &#x27;center&#x27;});
        doc.text(&#x60;FIT rate (NTD):&#x60;, page_lr_margin+10, header_bottom+header_column_pad_top+header_column_height*1, {width: header_column_width1, align: &#x27;center&#x27;});
        doc.text(&#x60;Plant Income (NTD):&#x60;, page_lr_margin+10, header_bottom+header_column_pad_top+header_column_height*2, {width: header_column_width1, align: &#x27;center&#x27;});
        doc.text(&#x60;Irradiation (kWh/m2)):&#x60;, page_lr_margin+280, header_bottom+header_column_pad_top+header_column_height*0, {width: header_column_width2, align: &#x27;center&#x27;});
        doc.text(&#x60;Performance Guarantee (%):&#x60;, page_lr_margin+280, header_bottom+header_column_pad_top+header_column_height*1, {width: header_column_width2, align: &#x27;center&#x27;});
        doc.text(&#x60;Performance Ratio (%):&#x60;, page_lr_margin+280, header_bottom+header_column_pad_top+header_column_height*2, {width: header_column_width2, align: &#x27;center&#x27;});

      //  doc.font(font_path, &#x27;Thin&#x27;)
        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        doc.text(&#x60;${Util.numberWithCommas(production_sum)}&#x60;, header_value_left1, header_bottom+header_column_pad_top+header_column_height*0, {width: header_column_width1, align: &#x27;left&#x27;});
        doc.text(&#x60;${fit_rate_str}&#x60;, header_value_left1, header_bottom+header_column_pad_top+header_column_height*1, {width: header_column_width1, align: &#x27;left&#x27;});
        doc.text(&#x60;${Util.numberWithCommas(plant_income)}&#x60;, header_value_left1, header_bottom+header_column_pad_top+header_column_height*2, {width: header_column_width1, align: &#x27;left&#x27;});
        doc.text(&#x60;${Util.numberWithCommas(irradiation_sum)}&#x60;, header_value_left2, header_bottom+header_column_pad_top+header_column_height*0, {width: header_column_width2, align: &#x27;left&#x27;});
        doc.text(&#x60;${Util.numberWithCommas(guarantee_capacity)}&#x60;, header_value_left2, header_bottom+header_column_pad_top+header_column_height*1, {width: header_column_width2, align: &#x27;left&#x27;});
        doc.text(&#x60;${Util.numberWithCommas(pr_total!&#x3D;null?Math.floor(pr_total*100)/100:&#x27;&#x27;)}&#x60;, header_value_left2, header_bottom+header_column_pad_top+header_column_height*2, {width: header_column_width2, align: &#x27;left&#x27;});

        var min &#x3D; Math.min(...pr_values, ...pg_values)
        var max &#x3D; Math.max(...pr_values, ...pg_values)

        var pad &#x3D; 5;
        var min2 &#x3D; (min-pad&lt;0)?0:min-pad;
        var max2 &#x3D; (max+pad&gt;100)?100:max+pad;

        var base64Image &#x3D; this.createProductionIrradiationChart(labels, production_values, irradiation_values);
        doc.image(Buffer.from(base64Image, &#x27;base64&#x27;), page_lr_margin, 230, {
          fit: [550, 250],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });

        var base64Image &#x3D; this.createPRChart(labels, production_values, pr_values, pg_values, min2, max2);
        doc.image(Buffer.from(base64Image, &#x27;base64&#x27;), page_lr_margin, 500, {
          fit: [550, 250],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });

        doc.addPage({
          size:&#x27;A4&#x27;
        });

        const table_y0 &#x3D; header_bottom;
        const column_count &#x3D; 5;
        const cell_height &#x3D; 20;
        const cell_width &#x3D; Math.floor((page_width-page_lr_margin*2)/column_count);
        const text_size &#x3D; 10;
        const cell_text_top &#x3D; Math.floor(cell_height-text_size)/2-2

        // table header background
        doc.rect(page_lr_margin, table_y0, page_width-page_lr_margin*2, cell_height);
        doc.fill(&quot;#112741&quot;)

        // table colume 1 background
        doc.rect(page_lr_margin, table_y0+cell_height, cell_width, cell_height*(data_count+1));
        doc.fill(&quot;#EDEDED&quot;)

        // table footer background
        doc.rect(page_lr_margin+cell_width, table_y0+cell_height*(data_count+1), page_width-page_lr_margin*2-cell_width, cell_height);
        doc.fill(&quot;#D5D6D5&quot;)

        // draw vertical line
        for (var c&#x3D;1; c&lt;column_count; c++) {
          var x &#x3D; page_lr_margin+c*cell_width;
          doc.lineCap(&#x27;butt&#x27;)
            .moveTo(x, table_y0)
            .lineTo(x, table_y0+(data_count+2)*cell_height)
            .stroke(&#x27;#D3D3D3&#x27;);
        }

        // draw horizontal line
        for (var n&#x3D;1; n&lt;data_count+1; n++) {
          var y &#x3D; table_y0+(n+1)*cell_height
          doc.lineCap(&#x27;butt&#x27;)
            .moveTo(page_lr_margin, y)
            .lineTo(page_width-page_lr_margin, y)
            .stroke(&#x27;#D3D3D3&#x27;);
        }

        doc.fontSize(text_size)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        var y &#x3D; table_y0+cell_text_top;
        doc.text(&#x60;Date&#x60;, page_lr_margin, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Irradiation(Wh/m2)&#x60;, page_lr_margin+cell_width, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Production(kWh)&#x60;, page_lr_margin+cell_width*2, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Performance Ratio(%)&#x60;, page_lr_margin+cell_width*3, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;PR Data Integrity(%)&#x60;, page_lr_margin+cell_width*4, y, {width: cell_width, align: &#x27;center&#x27;});

        doc.fillColor(&#x27;#000000&#x27;)
        var cell_width2 &#x3D; cell_width - 10
        if (cell_width2&lt;0) cell_width2&#x3D;0;
        for (var n&#x3D;0; n&lt;data_count; n++) {
          var y &#x3D; table_y0+(n+1)*cell_height+cell_text_top
          doc.text(labels[n], page_lr_margin, y, {width: cell_width, align: &#x27;center&#x27;});
          doc.text(Util.numberWithCommas(irradiation_values[n]), page_lr_margin+cell_width, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas(production_values[n]), page_lr_margin+cell_width*2, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas(pr_values[n]!&#x3D;null?Math.floor(pr_values[n]*100)/100:null), page_lr_margin+cell_width*3, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas(data_integrity_values[n]!&#x3D;null?data_integrity_values[n]*100:null), page_lr_margin+cell_width*4, y, {width: cell_width2, align: &#x27;right&#x27;});
        }

        var y &#x3D; table_y0+(data_count+1)*cell_height+cell_text_top
        doc.text(&#x27;Total&#x27;, page_lr_margin, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(Util.numberWithCommas(irradiation_values.reduce((a,b)&#x3D;&gt;a+b)), page_lr_margin+cell_width, y, {width: cell_width2, align: &#x27;right&#x27;});
        doc.text(Util.numberWithCommas(production_values.reduce((a,b)&#x3D;&gt;a+b)), page_lr_margin+cell_width*2, y, {width: cell_width2, align: &#x27;right&#x27;});
        var mean_pr &#x3D; pr_total!&#x3D;null?Math.floor(pr_total*100)/100:null
        doc.text(Util.numberWithCommas(mean_pr), page_lr_margin+cell_width*3, y, {width: cell_width2, align: &#x27;right&#x27;});
        var mean_integrity_values &#x3D; Math.floor(data_integrity_values.reduce((a,b)&#x3D;&gt;a+b)/data_integrity_values.length*10000)/100
        doc.text(Util.numberWithCommas(mean_integrity_values), page_lr_margin+cell_width*4, y, {width: cell_width2, align: &#x27;right&#x27;});

        doc.end()

        const buffer &#x3D; []
        doc.on(&#x27;data&#x27;, buffer.push.bind(buffer))
        doc.on(&#x27;end&#x27;, () &#x3D;&gt; {
          const data &#x3D; Buffer.concat(buffer)
          resolve(data)
        })
      } catch (ex) {
        reject(ex)
        return;
      }
    })

    return pdfBuffer
  }



  async generateEssPDF(this_user:UserWithPermission, time_type, domain_id, year:string|number, month:string|number&#x3D;null, timezone&#x3D;&#x27;Asia/Taipei&#x27;, device_type_id&#x3D;null, fake_data:string|boolean&#x3D;&#x27;false&#x27;): Promise&lt;Buffer&gt; {

    const page_width &#x3D; 595;
    const page_height &#x3D; 841;
    const page_lr_margin &#x3D; 20;
    const content_width &#x3D; page_width-page_lr_margin*2

    function drawPageHeader(doc, header_height) {
      let page_lr_margin &#x3D; 0
      let header_top &#x3D; 0
      doc.lineWidth(1);
      //doc.rect(page_lr_margin, header_top, page_width-page_lr_margin*2, 300);
      //doc.stroke(&quot;#CCCCCC&quot;);

      doc.rect(page_lr_margin, header_top, page_width-page_lr_margin*2, header_height);
      //doc.fillAndStroke(&quot;#000&quot;, &quot;#900&quot;)
      doc.fill(&quot;#093040&quot;)

      var logo_path2 &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;aegis.png&#x27;)
      const logo2_height &#x3D; 20;
      doc.image(logo_path2, page_lr_margin+10, header_top+(header_height-logo2_height)/2, {
        fit: [73, logo2_height],
        align: &#x27;center&#x27;,
        valign: &#x27;center&#x27;
      });

      var report_range_name &#x3D; (time_type&#x3D;&#x3D;&#x27;year&#x27;)?&#x27;Year&#x27;:&#x27;Monthly&#x27;
      var report_time &#x3D; (time_type&#x3D;&#x3D;&#x27;year&#x27;)?year:self.toEnShortMonthName(month)+&#x27;/&#x27;+year
      
      //  doc.font(font_path, &#x27;Bold&#x27;)
      doc.fontSize(12)
      doc.fillColor(&#x27;#FFFFFF&#x27;)
      doc.text(&#x60;${report_range_name} Report - ${report_time}&#x60;, 0, header_top+10, {width: page_width, align: &#x27;center&#x27;});
      //  doc.text(&#x60;${Util.numberWithCommas(bat_capacity)} kWh&#x60;, 0, header_top+10, {width: page_width-page_lr_margin-50, align: &#x27;right&#x27;});
    }


    //var device_type_name &#x3D; &#x27;pomcube&#x27;;
    var self &#x3D; this;
    const pdfBuffer: Buffer &#x3D; await new Promise(async (resolve, reject) &#x3D;&gt; {
      try {

        if (!(time_type&#x3D;&#x3D;&#x27;year&#x27; || time_type&#x3D;&#x3D;&#x27;month&#x27;)) {
          throw new HttpException(&#x27;time_type is must in {&quot;year&quot;, &quot;month&quot;}&#x27;, HttpStatus.BAD_REQUEST);
        }

        if (domain_id&#x3D;&#x3D;null || domain_id.trim()&#x3D;&#x3D;&#x27;&#x27; || isNaN(parseInt(domain_id))) {
          throw new HttpException(&#x27;domain_id is needed&#x27;, HttpStatus.BAD_REQUEST);
        }

        if (year&#x3D;&#x3D;null || (&#x27;&#x27;+year).trim()&#x3D;&#x3D;&#x27;&#x27; || (typeof(year)&#x3D;&#x3D;&#x27;string&#x27; &amp;&amp; isNaN(parseInt(year)))) {
          throw new HttpException(&#x27;year is needed&#x27;, HttpStatus.BAD_REQUEST);
        }
        year &#x3D; parseInt(&#x27;&#x27;+year);

        if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
          if (month&#x3D;&#x3D;null || (&#x27;&#x27;+month).trim()&#x3D;&#x3D;&#x27;&#x27; || (typeof(month)&#x3D;&#x3D;&#x27;string&#x27; &amp;&amp; isNaN(parseInt(month)))) {
            throw new HttpException(&#x27;month is invalid&#x27;, HttpStatus.BAD_REQUEST);
          }
          month &#x3D; parseInt(&#x27;&#x27;+month);
          if (month&lt;0 || month&gt;11) {
            throw new HttpException(&#x27;month is invalid. must be 0~11&#x27;, HttpStatus.BAD_REQUEST);
          }
        } else {
          month &#x3D; 0;
        }

        fake_data &#x3D; (fake_data&#x3D;&#x3D;&#x27;true&#x27; || fake_data&#x3D;&#x3D;&#x27;1&#x27;)

        if (timezone&#x3D;&#x3D;null) timezone&#x3D;&#x27;Asia/Taipei&#x27;
        if (/[^a-zA-Z0-9\/]/.test(timezone)) {
          throw new HttpException(&#x27;&quot;timezone&quot; is invalid&#x27;, HttpStatus.BAD_REQUEST);
        }

        var data_count &#x3D; 30;
        if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
          data_count &#x3D; 12;
        } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
          var m &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
          if (!m.isValid()) {
            throw new HttpException(&#x27;Invalid date.&#x27;, HttpStatus.BAD_REQUEST);
          }
          data_count &#x3D; m.daysInMonth();
        }

        var domain &#x3D; await this.domainService.findOne(this_user, domain_id);
        if (domain&#x3D;&#x3D;null) {
          throw new HttpException(&#x27;Domain not found.&#x27;, HttpStatus.NOT_FOUND);
        }

        var organization_id &#x3D; await this.domainService.getOrganizationId(domain_id);
        if (organization_id&#x3D;&#x3D;null) {
          throw new HttpException(&#x27;Organization of Domain not found.&#x27;, HttpStatus.NOT_FOUND);
        }
        var organization &#x3D; await this.domainService.findOne(this_user, organization_id);
        if (organization?.domain_name&#x3D;&#x3D;null || organization.domain_name.trim()&#x3D;&#x3D;&#x27;&#x27;) {
          throw new HttpException(&#x27;Organization name not found.&#x27;, HttpStatus.NOT_FOUND);
        }
        var organization_name &#x3D; organization.domain_name.trim()

        var device_type_name &#x3D; null
        var device_types &#x3D; await this.deviceTypeService.findAll(this_user)
        if (device_type_id!&#x3D;null) {
          var device_type &#x3D; device_types.find(x&#x3D;&gt;x.device_type_id&#x3D;&#x3D;device_type_id)
          if (device_type&#x3D;&#x3D;null) {
            throw new HttpException(&#x27;device_type_id (&#x27;+device_type_id+&#x27;) not found.&#x27;, HttpStatus.NOT_FOUND);
          }
          device_type_name &#x3D; device_type.device_type_name
        }

        var args &#x3D; (device_type_id&#x3D;&#x3D;null || (&#x27;&#x27;+device_type_id).trim()&#x3D;&#x3D;&#x27;&#x27;) ? {} : {device_type_id: device_type_id}
        var devices &#x3D; await self.domainServiceEx.getAllDevices(this_user, self.deviceService, domain_id, args, 1000000);
        var solar_capacity &#x3D; 0;
        var bat_capacity &#x3D; 0;
        var solar_area &#x3D; 0;
        for (var device of devices) {
          solar_capacity +&#x3D; (device.solar_capacity&#x3D;&#x3D;null)?0:device.solar_capacity
          bat_capacity +&#x3D; (device.bat_capacity&#x3D;&#x3D;null)?0:device.bat_capacity
          solar_area +&#x3D; (device.solar_area&#x3D;&#x3D;null)?0:device.solar_area
        }


        var m_start;
        var m_stop;
        if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
          m_start &#x3D; moment.tz({ year: year, month: 0, day: 1 }, timezone);
          //m_start.subtract(1, &#x27;months&#x27;)
          m_stop &#x3D; moment.tz({ year: year+1, month: 0, day: 1 }, timezone);
        } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
          m_start &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
          //m_start.subtract(1, &#x27;days&#x27;)
          m_stop &#x3D; moment.tz({ year: year, month: month, day: 1 }, timezone);
          m_stop.add(1, &#x27;months&#x27;)
        }

        var table_energy;
        var table_soc;
        var table_solar_prediction;

        if (!fake_data) {

          var params_base &#x3D; {
            organization_id: organization_id,
            device_type_name: device_type_name,
            domain_id: domain_id,
            timezone: timezone,
            start: m_start.toISOString(),
            stop: m_stop.toISOString(),
            group_by: &#x27;!DeviceName,_field&#x27;,
            create_empty: true,
            pivot_columns: &#x27;_field&#x27;
          }

          if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
            params_base[&#x27;every&#x27;] &#x3D; &#x27;1mo&#x27;
          } else if (time_type&#x3D;&#x3D;&#x27;month&#x27;) {
            params_base[&#x27;every&#x27;] &#x3D; &#x27;1d&#x27;
          }

          var device_output_name &#x3D; null;
          if (device_type_name&#x3D;&#x3D;&#x27;pomcube&#x27;) {
            device_output_name &#x3D; &#x27;pomcube_data&#x27;
          } else if (device_type_name&#x3D;&#x3D;&#x27;pv_inverter&#x27;) {
            device_output_name &#x3D; &#x27;hermes_report&#x27;
          }

          var params_energy &#x3D; Object.assign({
            device_output_name: device_output_name,
            fields: &#x27;LoadEnergy,SolarEnergy,GridEnergy&#x27;,
            differenceNonNegativeSource: true,
            time_function: &#x27;sum&#x27;,
            group_function: &#x27;sum&#x27;
          }, params_base)

          var params_soc &#x3D; Object.assign({
            device_output_name: device_output_name,
            fields: &#x27;BatSoC&#x27;,
            time_function: &#x27;mean&#x27;,
            group_function: &#x27;mean&#x27;
          }, params_base)

          var params_solar_prediction &#x3D; Object.assign({
            device_output_name: &#x27;solar_prediction&#x27;,
            fields: &#x27;DirectRadiation,SolarPower&#x27;,
            time_function: &#x27;sum&#x27;,
            group_function: &#x27;sum&#x27;
          }, params_base)

          table_energy &#x3D; await this.deviceDataService.query(this_user, params_energy)
          table_soc &#x3D; await this.deviceDataService.query(this_user, params_soc)
          table_solar_prediction &#x3D; await this.deviceDataService.query(this_user, params_solar_prediction)
        }


        var load_energys &#x3D; []
        var solar_energys &#x3D; []
        var grid_energys &#x3D; []
        var socs &#x3D; []
        var prediction_energys &#x3D; []
        var curtailment_ratios &#x3D; []

        var labels &#x3D; [];
        for (var n&#x3D;0; n&lt;data_count; n++) {
          var label &#x3D; &#x27;&#x27;+(n+1);
          if (time_type&#x3D;&#x3D;&#x27;year&#x27;) {
            var m &#x3D; moment.tz({ year: 2023, month: n, day: 1 }, timezone);
            m.locale(&#x27;en&#x27;);
            label &#x3D; m.format(&#x27;MMM&#x27;);
          }
          labels.push(label);

          if (n&lt;table_energy.length) {
            load_energys.push((table_energy[n].LoadEnergy&#x3D;&#x3D;null) ? null : -table_energy[n].LoadEnergy)
            solar_energys.push(table_energy[n].SolarEnergy)
            grid_energys.push(table_energy[n].GridEnergy)
            socs.push(table_soc[n].BatSoC)
            var prediction_energy &#x3D; table_solar_prediction[n].SolarPower&#x3D;&#x3D;null ? null : table_solar_prediction[n].SolarPower/4/1000
            prediction_energys.push(prediction_energy)
            var curtailment_ratio &#x3D; (prediction_energy!&#x3D;null &amp;&amp; table_energy[n].SolarEnergy!&#x3D;null) ? (1-(table_energy[n].SolarEnergy/prediction_energy))*100 : null
            if (curtailment_ratio!&#x3D;null) {
              if (curtailment_ratio&gt;100) curtailment_ratio &#x3D; 100;
              if (curtailment_ratio&lt;0) curtailment_ratio &#x3D; 0;
            }
            curtailment_ratios.push(curtailment_ratio)
          } else {
            load_energys.push(null)
            solar_energys.push(null)
            grid_energys.push(null)
            socs.push(null)
            prediction_energys.push(null)
            curtailment_ratios.push(null)
          }
        }

        const doc &#x3D; new PDFDocument({
          size: &#x27;A4&#x27;, // A4 (595.28 x 841.89)
          bufferPages: true,
        })

        //var font_path &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;font&#x27;, &#x27;Noto_Sans_TC&#x27;, &#x27;NotoSansTC-VariableFont_wght.ttf&#x27;)
        var font_path_medium &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;font&#x27;, &#x27;Noto_Sans_TC&#x27;, &#x27;static&#x27;, &#x27;NotoSansTC-Medium.ttf&#x27;)
        var font_path_regular &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;font&#x27;, &#x27;Noto_Sans_TC&#x27;, &#x27;static&#x27;, &#x27;NotoSansTC-Regular.ttf&#x27;)

        doc.font(font_path_regular)
        //doc.font(font_path, &#x27;Regular&#x27;)

  /*
        doc.addPage({
          margins: {
            top: 50,
            bottom: 50,
            left: 50,
            right: 50
          }
        });
  */

        var yy &#x3D; 0;
        const header_top &#x3D; 0;
        const header_height &#x3D; 40;
        var header_bottom &#x3D; header_top+header_height;


        /*
        var logo_path &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;derui.png&#x27;)
        doc.image(logo_path, page_width-page_lr_margin-100, 15, {
          fit: [100, 24],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });
        */
        

        drawPageHeader(doc, header_height);
        yy +&#x3D; header_height
        yy +&#x3D; 12

        var m &#x3D; moment.tz({}, timezone);

        //  doc.font(font_path, &#x27;Bold&#x27;)
        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        doc.text(&#x60;Site Name : ${domain.domain_name}&#x60;, page_lr_margin, yy);
        doc.text(&#x60;Report Generation Date : ${m.format(&#x27;MM-DD-YYYY HH:mm:ss&#x27;)}&#x60;, page_lr_margin + content_width/2, yy, {width: content_width/2, align: &#x27;left&#x27;});
        yy +&#x3D; 24

        doc.text(&#x60;Coordinates: ${domain.lat}° N, ${domain.lng}° E&#x60;, page_lr_margin, yy);
        yy +&#x3D; 32
        
        doc.fontSize(18)
        doc.text(&#x60;Overview&#x60;, page_lr_margin, yy);
        yy +&#x3D; 30

        var line_height &#x3D; 20
        var c1_name_left &#x3D; page_lr_margin + 10
        var c1_value_left &#x3D; page_lr_margin + 160
        var content_width_div2 &#x3D; content_width/2
        var c2_name_left &#x3D; page_lr_margin + content_width/2 + 10
        var c2_value_left &#x3D; page_lr_margin + content_width/2 + 160
        var overview_title_color &#x3D; &#x27;#707070&#x27;

        var hh &#x3D; 28
        doc.lineWidth(1);
        doc.rect(page_lr_margin, yy, content_width, hh);
        doc.fillAndStroke(overview_title_color, overview_title_color)
        doc.fontSize(12)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        doc.text(&#x60;Solar System&#x60;, c1_name_left, yy+4);
        doc.text(&#x60;Carbon Emission Reduction&#x60;, c2_name_left, yy+4);
        yy +&#x3D; hh
  
        hh &#x3D; 64
        doc.rect(page_lr_margin, yy, content_width/2, hh);
        doc.rect(page_lr_margin+content_width/2, yy, content_width/2, hh);
        doc.stroke(&quot;#CCCCCC&quot;);
        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        var yy2 &#x3D; yy + 10
        doc.text(&#x60;Solar Panel Area :&#x60;, c1_name_left, yy2 + line_height*0);
        doc.text(&#x60;${Util.numberWithCommas(solar_area)} m²&#x60;, c1_value_left, yy2 + line_height*0, {width:content_width_div2});
        doc.text(&#x60;Solar Capacity :&#x60;, c1_name_left, yy2 + line_height*1);
        doc.text(&#x60;${Util.numberWithCommas(solar_capacity)} kWp&#x60;, c1_value_left, yy2 + line_height*1, {width:content_width_div2});
        doc.text(&#x60;Carbon Reduction :&#x60;, c2_name_left, yy2 + line_height*0);
        doc.text(&#x60;${Util.numberWithCommas(Util.sum(solar_energys)*0.494)} kgCO2&#x60;, c2_value_left, yy2 + line_height*0, {width:content_width_div2});
        yy +&#x3D; hh


        var hh &#x3D; 28
        doc.lineWidth(1);
        doc.rect(page_lr_margin, yy, content_width, hh);
        doc.fillAndStroke(overview_title_color, overview_title_color)
        doc.fontSize(12)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        doc.text(&#x60;Energy Production&#x60;, c1_name_left, yy+4);
        doc.text(&#x60;Battery&#x60;, c2_name_left, yy+4);
        yy +&#x3D; hh
  
        hh &#x3D; 100
        doc.rect(page_lr_margin, yy, content_width/2, hh);
        doc.rect(page_lr_margin+content_width/2, yy, content_width/2, hh);
        doc.stroke(&quot;#CCCCCC&quot;);
        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        var yy2 &#x3D; yy + 10
        doc.text(&#x60;Daily Production :&#x60;, c1_name_left, yy2 + line_height*0);
        doc.text(&#x60;Max : ${Util.numberWithCommas(Util.max(solar_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*0, {width:content_width_div2});
        doc.text(&#x60;Min : ${Util.numberWithCommas(Util.min(solar_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*1, {width:content_width_div2});
        doc.text(&#x60;Avg : ${Util.numberWithCommas(Util.avg(solar_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*2, {width:content_width_div2});
        doc.text(&#x60;Total Production :&#x60;, c1_name_left, yy2 + line_height*3);
        doc.text(&#x60;${Util.numberWithCommas(Util.sum(solar_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*3, {width:content_width_div2});
        doc.text(&#x60;Battery Capacity :&#x60;, c2_name_left, yy2 + line_height*0);
        doc.text(&#x60;${Util.numberWithCommas(bat_capacity)} kWh&#x60;, c2_value_left, yy2 + line_height*0, {width:content_width_div2});
        doc.text(&#x60;Daily SOC :&#x60;, c2_name_left, yy2 + line_height*1);
        doc.text(&#x60;Max : ${Util.numberWithCommas(Util.max(socs))} %&#x60;, c2_value_left, yy2 + line_height*1, {width:content_width_div2});
        doc.text(&#x60;Min : ${Util.numberWithCommas(Util.min(socs))} %&#x60;, c2_value_left, yy2 + line_height*2, {width:content_width_div2});
        doc.text(&#x60;Avg : ${Util.numberWithCommas(Util.avg(socs))} %&#x60;, c2_value_left, yy2 + line_height*3, {width:content_width_div2});
        yy +&#x3D; hh


        var hh &#x3D; 28
        doc.lineWidth(1);
        doc.rect(page_lr_margin, yy, content_width, hh);
        doc.fillAndStroke(overview_title_color, overview_title_color)
        doc.fontSize(12)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        doc.text(&#x60;Load Consumption&#x60;, c1_name_left, yy+4);
        yy +&#x3D; hh
  
        hh &#x3D; 100
        doc.rect(page_lr_margin, yy, content_width, hh);
        doc.stroke(&quot;#CCCCCC&quot;);
        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        var yy2 &#x3D; yy + 10
        doc.text(&#x60;Daily Consumption :&#x60;, c1_name_left, yy2 + line_height*0);
        doc.text(&#x60;Max : ${Util.numberWithCommas(-Util.min(load_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*0, {width:content_width_div2});
        doc.text(&#x60;Min : ${Util.numberWithCommas(-Util.max(load_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*1, {width:content_width_div2});
        doc.text(&#x60;Avg : ${Util.numberWithCommas(-Util.avg(load_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*2, {width:content_width_div2});
        doc.text(&#x60;Total load consumption:&#x60;, c1_name_left, yy2 + line_height*3);
        doc.text(&#x60;${Util.numberWithCommas(-Util.sum(load_energys))} kWh&#x60;, c1_value_left, yy2 + line_height*3, {width:content_width_div2});
        yy +&#x3D; hh

        yy +&#x3D; 24
        doc.fontSize(18)
        doc.text(&#x60;Equipment List&#x60;, page_lr_margin, yy);
        yy +&#x3D; 30

        var col_width &#x3D; content_width/5

        var hh &#x3D; 28
        var yy2 &#x3D; yy + 4
        doc.lineWidth(1);
        doc.rect(page_lr_margin, yy, content_width, hh);
        doc.fillAndStroke(overview_title_color, &quot;#000000&quot;)
        doc.fontSize(12)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        doc.text(&#x60;Device ID&#x60;, page_lr_margin, yy2, {width: col_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Device Name&#x60;, page_lr_margin+col_width, yy2, {width: col_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Device Type&#x60;, page_lr_margin+col_width*2, yy2, {width: col_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Battery Capacity&#x60;, page_lr_margin+col_width*3, yy2, {width: col_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Solar Capacity&#x60;, page_lr_margin+col_width*4, yy2, {width: col_width, align: &#x27;center&#x27;});

        doc.fontSize(12)
        doc.fillColor(&#x27;#000000&#x27;)
        var yy3 &#x3D; yy + 34
        for (var device of devices) {
          if (yy3&gt;page_height-100) {
            doc.addPage({
              size:&#x27;A4&#x27;
            });
            drawPageHeader(doc, header_height);
            yy3 &#x3D; 100
          }
          var device_type &#x3D; device_types.find(x&#x3D;&gt;x.device_type_id&#x3D;&#x3D;device.device_type_id)
          let device_type_name2 &#x3D; (device_type&#x3D;&#x3D;null)?&#x27;&#x27;:device_type.device_type_alias_name;

          doc.fontSize(12)
          doc.fillColor(&#x27;#000000&#x27;)
  
          let bat_capacity_text &#x3D; (device.bat_capacity&#x3D;&#x3D;null) ? &#x27;&#x27; : device.bat_capacity + &#x27; kWh&#x27;;
          let solar_capacity_text &#x3D; (device.solar_capacity&#x3D;&#x3D;null) ? &#x27;&#x27; : device.solar_capacity + &#x27;&#x27;;

          doc.text(device.device_name, page_lr_margin, yy3, {width: col_width, align: &#x27;center&#x27;});
          doc.text(device.device_alias_name, page_lr_margin+col_width, yy3, {width: col_width, align: &#x27;center&#x27;});
          doc.text(device_type_name2, page_lr_margin+col_width*2, yy3, {width: col_width, align: &#x27;center&#x27;});
          doc.text(bat_capacity_text, page_lr_margin+col_width*3, yy3, {width: col_width, align: &#x27;center&#x27;});
          doc.text(solar_capacity_text, page_lr_margin+col_width*4, yy3, {width: col_width, align: &#x27;center&#x27;});
          doc.moveTo(page_lr_margin, yy3+39)
          doc.lineTo(page_lr_margin+content_width, yy3+34)
          doc.stroke(overview_title_color)
          yy3 +&#x3D; 40
        }

        doc.addPage({
          size:&#x27;A4&#x27;
        });

        drawPageHeader(doc, header_height);

        var min &#x3D; socs.reduce(
          (accumulator, currentValue) &#x3D;&gt; (currentValue&#x3D;&#x3D;null) ? accumulator : Math.min(accumulator, currentValue),
          Number.MAX_SAFE_INTEGER
        );
        
        var max &#x3D; Math.max(...socs)

        var pad &#x3D; 5;
        var min2 &#x3D; (min-pad&lt;0)?0:min-pad;
        var max2 &#x3D; (max+pad&gt;100)?100:max+pad;

        doc.fontSize(18)
        doc.fillColor(&#x27;#000000&#x27;)
        doc.text(&#x27;Energy Analysis Chart&#x27;, page_lr_margin, header_height+30, {width: content_width});
 
        doc.fontSize(12)
        doc.text(&#x27;Energy Operation&#x27;, page_lr_margin, header_height+100, {width: content_width, align: &#x27;center&#x27;});
        
        var base64Image &#x3D; this.createEnergyChart(labels, load_energys, solar_energys, grid_energys, socs, min2, max2)
        doc.image(Buffer.from(base64Image, &#x27;base64&#x27;), page_lr_margin, header_height+120, {
          fit: [550, 250],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });

        doc.fontSize(12)
        doc.text(&#x27;Solar Energy Production and Curtailment Analysis&#x27;, page_lr_margin, header_height+460, {width: content_width, align: &#x27;center&#x27;});

        var base64Image &#x3D; this.createCurtailmentChart(labels, solar_energys, prediction_energys, curtailment_ratios)
        doc.image(Buffer.from(base64Image, &#x27;base64&#x27;), page_lr_margin, header_height+480, {
          fit: [550, 250],
          align: &#x27;center&#x27;,
          valign: &#x27;center&#x27;
        });

        doc.addPage({
          size:&#x27;A4&#x27;
        });

        drawPageHeader(doc, header_height);

        doc.fontSize(18)
        doc.fillColor(&#x27;#000000&#x27;)
        doc.text(&#x27;Energy Information&#x27;, page_lr_margin, header_height+30, {width: content_width});
        
        const table_y0 &#x3D; header_height + 64;
        const column_count &#x3D; 6;
        const cell_height &#x3D; 20;
        const cell_width &#x3D; Math.floor((page_width-page_lr_margin*2)/column_count);
        const text_size &#x3D; 10;
        const cell_text_top &#x3D; Math.floor(cell_height-text_size)/2-2

        // table header background
        doc.rect(page_lr_margin, table_y0, page_width-page_lr_margin*2, cell_height);
        doc.fill(&quot;#112741&quot;)

        // table colume 1 background
        doc.rect(page_lr_margin, table_y0+cell_height, cell_width, cell_height*(data_count+1));
        doc.fill(&quot;#EDEDED&quot;)

        // table footer background
        doc.rect(page_lr_margin+cell_width, table_y0+cell_height*(data_count+1), page_width-page_lr_margin*2-cell_width, cell_height);
        doc.fill(&quot;#D5D6D5&quot;)

        // draw vertical line
        for (var c&#x3D;1; c&lt;column_count; c++) {
          var x &#x3D; page_lr_margin+c*cell_width;
          doc.lineCap(&#x27;butt&#x27;)
            .moveTo(x, table_y0)
            .lineTo(x, table_y0+(data_count+2)*cell_height)
            .stroke(&#x27;#D3D3D3&#x27;);
        }

        // draw horizontal line
        for (var n&#x3D;1; n&lt;data_count+1; n++) {
          var y &#x3D; table_y0+(n+1)*cell_height
          doc.lineCap(&#x27;butt&#x27;)
            .moveTo(page_lr_margin, y)
            .lineTo(page_width-page_lr_margin, y)
            .stroke(&#x27;#D3D3D3&#x27;);
        }

        doc.fontSize(text_size)
        doc.fillColor(&#x27;#FFFFFF&#x27;)
        var y &#x3D; table_y0+cell_text_top;
        doc.text(&#x60;Date&#x60;, page_lr_margin, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Solar(kWh)&#x60;, page_lr_margin+cell_width, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Load(kWh)&#x60;, page_lr_margin+cell_width*2, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Grid(kWh)&#x60;, page_lr_margin+cell_width*3, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;SoC(%)&#x60;, page_lr_margin+cell_width*4, y, {width: cell_width, align: &#x27;center&#x27;});
        doc.text(&#x60;Curtailment(%)&#x60;, page_lr_margin+cell_width*5, y, {width: cell_width, align: &#x27;center&#x27;});

        doc.fillColor(&#x27;#000000&#x27;)
        var cell_width2 &#x3D; cell_width - 10
        if (cell_width2&lt;0) cell_width2&#x3D;0;
        for (var n&#x3D;0; n&lt;data_count; n++) {
          var y &#x3D; table_y0+(n+1)*cell_height+cell_text_top
          doc.text(labels[n], page_lr_margin, y, {width: cell_width, align: &#x27;center&#x27;});
          doc.text(Util.numberWithCommas(solar_energys[n]), page_lr_margin+cell_width, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas((load_energys[n]&#x3D;&#x3D;null) ? null : -load_energys[n]), page_lr_margin+cell_width*2, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas(grid_energys[n]), page_lr_margin+cell_width*3, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas(socs[n]), page_lr_margin+cell_width*4, y, {width: cell_width2, align: &#x27;right&#x27;});
          doc.text(Util.numberWithCommas(curtailment_ratios[n]), page_lr_margin+cell_width*5, y, {width: cell_width2, align: &#x27;right&#x27;});
        }

        var y &#x3D; table_y0+(data_count+1)*cell_height+cell_text_top
        doc.text(&#x27;Total&#x27;, page_lr_margin, y, {width: cell_width, align: &#x27;center&#x27;});

        doc.text(Util.numberWithCommas(Util.sum(solar_energys)), page_lr_margin+cell_width, y, {width: cell_width2, align: &#x27;right&#x27;});
        doc.text(Util.numberWithCommas(-Util.sum(load_energys)), page_lr_margin+cell_width*2, y, {width: cell_width2, align: &#x27;right&#x27;});
        doc.text(Util.numberWithCommas(Util.sum(grid_energys)), page_lr_margin+cell_width*3, y, {width: cell_width2, align: &#x27;right&#x27;});
        doc.text(Util.numberWithCommas(Util.avg(socs)), page_lr_margin+cell_width*4, y, {width: cell_width2, align: &#x27;right&#x27;});
        doc.text(Util.numberWithCommas(Util.avg(curtailment_ratios)), page_lr_margin+cell_width*5, y, {width: cell_width2, align: &#x27;right&#x27;});

        doc.end()

        const buffer &#x3D; []
        doc.on(&#x27;data&#x27;, buffer.push.bind(buffer))
        doc.on(&#x27;end&#x27;, () &#x3D;&gt; {
          const data &#x3D; Buffer.concat(buffer)
          resolve(data)
        })
      } catch (ex) {
        reject(ex)
        return;
      }
    })

    return pdfBuffer
  }


  /*
  var time_tariffs:Array&lt;{time:number, tariff:number}&gt; &#x3D; [
      {
          time: 1716781019000,
          tariff: 20
      }, {
          time: 1716781119000,
          tariff: 30
      }, {
          time: 1716781219000,
          tariff: 40
      }
  ];

  代表
  時間 1716781019000~1716781119000 費率 20
  時間 1716781119000~1716781219000 費率 30
  時間 1716781119000~無限 費率 40

  mergeTariff(time_tariffs, start_time, end_time, tariff):Array&lt;{time:number, tariff:number}&gt; {}

  範例一:
  輸入
  mergeTariff(time_tariffs, 1716781009000, 1716781018000, 10);
  輸出
  [
      {
          time: 1716781009000,
          tariff: 10
      }, {
          time: 1716781018000,
          tariff: null
      }, {
          time: 1716781019000,
          tariff: 20
      }, {
          time: 1716781119000,
          tariff: 30
      }, {
          time: 1716781219000,
          tariff: 40
      }
  ]

  範例二:
  輸入
  mergeTariff(time_tariffs, 1716781019000, 1716781215000, 50);
  輸出
  [
      {
          time: 1716781019000,
          tariff: 50
      }, {
          time: 1716781215000,
          tariff: 30
      }, {
          time: 1716781219000,
          tariff: 40
      }
  ];
  */
  mergeTariff(time_tariffs:Array&lt;{time:number, tariff:number}&gt;, start_time:number, end_time:number, tariff:number):Array&lt;{time:number, tariff:number}&gt; {
    if (start_time&gt;&#x3D;end_time) return time_tariffs;
    if (time_tariffs.length&#x3D;&#x3D;0) {
      time_tariffs.push({
        time: start_time,
        tariff: tariff
      })
      time_tariffs.push({
        time: end_time,
        tariff: null
      })
    } else if (end_time&lt;time_tariffs[0].time) {
      time_tariffs.splice(0,0,{
        time: start_time,
        tariff: tariff
      })
      time_tariffs.splice(1,0,{
        time: end_time,
        tariff: null
      })
    } else if (end_time&#x3D;&#x3D;time_tariffs[0].time) {
      time_tariffs.splice(0,0,{
        time: start_time,
        tariff: tariff
      })
    } else {
      var start_index &#x3D; time_tariffs.findIndex(x&#x3D;&gt;x.time&gt;&#x3D;start_time)
      var end_index &#x3D; time_tariffs.findIndex(x&#x3D;&gt;x.time&gt;&#x3D;end_time)
      if (start_index&#x3D;&#x3D;-1) {
        time_tariffs.push({
          time: start_time,
          tariff: tariff
        })
        time_tariffs.push({
          time: end_time,
          tariff: null
        })
      } else {
        if (end_index!&#x3D;-1) {
          if (time_tariffs[end_index].time !&#x3D; end_time) {
            if (end_index-1&gt;&#x3D;0) time_tariffs[end_index-1].time &#x3D; end_time;
            end_index --;
          }
        }
        if (start_time&gt;time_tariffs[start_index].time) start_index++;
        var delete_count &#x3D; 0;
        if (end_index&#x3D;&#x3D;-1) {
          delete_count &#x3D; time_tariffs.length - start_index;
        } else {
          delete_count &#x3D; end_index - start_index;
        }
        if (delete_count&lt;0) delete_count &#x3D; 0;
        time_tariffs.splice(start_index,delete_count,{
          time: start_time,
          tariff: tariff
        })
        if (end_time&gt;time_tariffs[time_tariffs.length-1].time) {
          time_tariffs.push({
            time: end_time,
            tariff: null
          })
        }
      }
    }
    return time_tariffs
  }

  async getDomainFeedInTariff(this_user:UserWithPermission, domain_id):Promise&lt;{ time: string; tariff: number; }[]&gt; {
    var domainService &#x3D; this.domainService;
    var cache_domains &#x3D; await domainService.getCacheDomains();
    var time_tariffs:Array&lt;{time:number, tariff:number}&gt; &#x3D; [];
    var domid &#x3D; domain_id;
    var domain_ids &#x3D; [];
    while (domid!&#x3D;null) {
      var cache_domain &#x3D; cache_domains.find(x&#x3D;&gt;x.domain_id&#x3D;&#x3D;domid)
      if (cache_domain&#x3D;&#x3D;null) break;
      domain_ids.push(cache_domain.domain_id);
      domid &#x3D; cache_domain.parent_domain_id;
    }
    if (domain_ids.length&#x3D;&#x3D;0) return [];
    var domains &#x3D; await this.domainService.findAll(this_user, {
      where:{
        domain_id: In(domain_ids)
      }
    })
    if (domains.length&#x3D;&#x3D;0) return [];
    for (var n&#x3D;domain_ids.length-1; n&gt;&#x3D;0; n--) {
      var domid &#x3D; domain_ids[n];
      var domain &#x3D; domains.find(x&#x3D;&gt;x.domain_id&#x3D;&#x3D;domid)
      if (domain.feed_in_tariffs&#x3D;&#x3D;null || domain.feed_in_tariffs.trim()&#x3D;&#x3D;&#x27;&#x27;) continue;
      try {
        var tariffs &#x3D; JSON.parse(domain.feed_in_tariffs)
        if (!Array.isArray(tariffs)) continue;
        var tariffs2 &#x3D; [];
        for (var tariff of tariffs) {
          var d_start:any &#x3D; new Date(tariff.start_time);
          if (isNaN(d_start)) continue;
          var d_end:any &#x3D; new Date(tariff.end_time);
          if (isNaN(d_end)) continue;
          tariffs2.push({
            start_time: d_start.getTime(),
            end_time: d_end.getTime(),
            tariff: tariff.tariff
          })
        }
        tariffs2.sort((a,b)&#x3D;&gt;{
          return a.start_time-b.start_time
        })
        for (var tariff of tariffs2) {
          this.mergeTariff(time_tariffs, tariff.start_time, tariff.end_time, tariff.tariff);
        }
      } catch (ex) {
        console.log(ex);
      }
    }
    var iso_time_tariffs:Array&lt;{time:string, tariff:number}&gt; &#x3D; [];
    for (var time_tariff of time_tariffs) {
      iso_time_tariffs.push({
        time: (new Date(time_tariff.time)).toISOString(),
        tariff: time_tariff.tariff
      })
    }
    return iso_time_tariffs;
  }

  async getEssHermesIncome(organization_name, devices, start_time, end_time) {
    if (devices.length&#x3D;&#x3D;0) return 0;
    var device_names &#x3D; devices.map(x&#x3D;&gt;x.device_name)
    var where &#x3D; {
      DeviceName: device_names
    }
    var params &#x3D; {
      start: start_time,
      stop: end_time,
      where: JSON.stringify(where),
      fields: &#x27;RevenueToday&#x27;,
      every: &#x27;1d&#x27;,
      time_function: &#x27;last&#x27;,
      time_src: &#x27;_start&#x27;,
      group_by: &#x27;!DeviceName&#x27;,
      group_function: &#x27;sum&#x27;
    }
    var revenue_todays &#x3D; await this.deviceDataService.queryInflux(organization_name, &#x27;hermes_today_power_value&#x27;, params)
    var revenue_sum &#x3D; revenue_todays.reduce((s,x)&#x3D;&gt;s+x._value, 0)
    return revenue_sum
  }

  async getGenerateMoney(this_user:UserWithPermission, domain_id, device_type_id, start_time, end_time) {
    var domainServiceEx &#x3D; this.domainServiceEx;

    var start_time_date:any &#x3D; new Date(start_time)
    var end_time_date:any &#x3D; new Date(end_time)
    if (isNaN(start_time_date)) {
      throw new HttpException(&#x27;start_time is invalid&#x27;, HttpStatus.BAD_REQUEST);
    }
    if (isNaN(end_time_date)) {
      throw new HttpException(&#x27;end_time is invalid&#x27;, HttpStatus.BAD_REQUEST);
    }

    /*
    var fluxQuery &#x3D; &#x27;&#x27;;
    fluxQuery +&#x3D; &#x27;query1&#x3D;from(bucket: &quot;鼎硯&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; range(start:0, stop: 2024-05-25T08:00:00Z)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_measurement&quot;] &#x3D;&#x3D; &quot;hermes_report&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_field&quot;] &#x3D;&#x3D; &quot;SolarEnergy&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;device_name&quot;] &#x3D;&#x3D; &quot;EMS000002&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; last()&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; group()&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; sum()&#x27;;
//    fluxQuery +&#x3D; &#x27;|&gt; map(fn: (r) &#x3D;&gt; ({ r with table: 0 }))&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; map(fn: (r) &#x3D;&gt; ({ r with _time: 2024-05-25T08:00:00Z }))&#x27;;
    fluxQuery +&#x3D; &#x27;query2&#x3D;from(bucket: &quot;鼎硯&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; range(start:0, stop: 2024-05-25T08:00:00Z)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_measurement&quot;] &#x3D;&#x3D; &quot;hermes_report&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_field&quot;] &#x3D;&#x3D; &quot;SolarEnergy&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; filter(fn: (r) &#x3D;&gt; r[&quot;device_name&quot;] &#x3D;&#x3D; &quot;EMS000003&quot;)&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; last()&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; group()&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; sum()&#x27;;
  //  fluxQuery +&#x3D; &#x27;|&gt; map(fn: (r) &#x3D;&gt; ({ r with table: 1 }))&#x27;;
    fluxQuery +&#x3D; &#x27;|&gt; map(fn: (r) &#x3D;&gt; ({ r with _time: 2024-05-26T08:00:00Z }))&#x27;;
    fluxQuery +&#x3D; &#x27;union(tables: [query1, query2])&#x27;;
    datas &#x3D; await this.queryByFlux(fluxQuery);
    console.log(datas)
    */



    var ret &#x3D; {
      tariffs: [],
      incomes: [],
      ess_hermes_income: 0,
      total_income: 0
    }


    var organization_name &#x3D; null;
    var domain &#x3D; null;
    var devices &#x3D; [];
    var domain_id2 &#x3D; null;
    if (domain_id!&#x3D;null &amp;&amp; (&#x27;&#x27;+domain_id).trim()!&#x3D;&#x27;&#x27;) {
      domain_id2 &#x3D; parseInt(domain_id);
      if (isNaN(domain_id2)) {
        throw new HttpException(&#x27;domain_id is invalid&#x27;, HttpStatus.BAD_REQUEST);
      }
      domain &#x3D; await domainServiceEx.findOne(this_user, domain_id2);
      if (domain&#x3D;&#x3D;null) {
        throw new HttpException(&#x27;domain not found&#x27;, HttpStatus.NOT_FOUND);
      }

      var organization_id &#x3D; await this.domainService.getOrganizationId(domain_id);
      if (organization_id&#x3D;&#x3D;null) {
        throw new HttpException(&#x27;Organization of Domain not found.&#x27;, HttpStatus.NOT_FOUND);
      }
      var organization &#x3D; await this.domainService.findOne(this_user, organization_id);
      if (organization?.domain_name&#x3D;&#x3D;null || organization.domain_name.trim()&#x3D;&#x3D;&#x27;&#x27;) {
        throw new HttpException(&#x27;Organization name not found.&#x27;, HttpStatus.NOT_FOUND);
      }
      organization_name &#x3D; organization.domain_name.trim()

      var args &#x3D; (device_type_id&#x3D;&#x3D;null || (&#x27;&#x27;+device_type_id).trim()&#x3D;&#x3D;&#x27;&#x27;) ? {} : {device_type_id: device_type_id}
      devices &#x3D; await domainServiceEx.getAllDevices(this_user, this.deviceService, domain_id2, args, 1000000);
    }
    if (devices.length&#x3D;&#x3D;0) return ret;


    var device_type_ess_hermes &#x3D; await this.deviceTypeService.findAll(this_user, {where:{device_type_name:&#x27;ess_hermes&#x27;}})
    if (device_type_ess_hermes.length&#x3D;&#x3D;0) {
      throw new HttpException(&#x27;Device type:&quot;ess_hermes&quot; not found.&#x27;, HttpStatus.NOT_FOUND);
    }
    var device_type_id_ess_hermes &#x3D; device_type_ess_hermes[0].device_type_id
    var ess_hermes_devices &#x3D; devices.filter(x&#x3D;&gt;x.device_type_id&#x3D;&#x3D;device_type_id_ess_hermes)
    var other_devices &#x3D; devices.filter(x&#x3D;&gt;x.device_type_id!&#x3D;device_type_id_ess_hermes)

    var ess_hermes_income &#x3D; await this.getEssHermesIncome(organization_name, ess_hermes_devices, start_time, end_time)

    var iso_time_tariffs:any &#x3D; [];
    var time_tariffs:Array&lt;{time:string, tariff:number, energy:number, diff_energy:number, amount:number}&gt; &#x3D; []
    var total_amount &#x3D; 0

    do {
      if (other_devices.length&#x3D;&#x3D;0) break;
      var device_names &#x3D; [];
      for (var device of other_devices) {
        //device_names.push(device.device_name)
        device_names.push(&#x60;r[&quot;${AppConfigService.DEVICE_NAME_FIELD}&quot;]&#x3D;&#x3D;&quot;${device.device_name}&quot;&#x60;)
      }
      var device_names_str &#x3D; device_names.join(&#x27; or &#x27;);
      iso_time_tariffs &#x3D; await this.getDomainFeedInTariff(this_user, domain_id2);
      time_tariffs &#x3D; JSON.parse(JSON.stringify(iso_time_tariffs))

      function insertTime(time_tariffs, time) {
        var ret_index &#x3D; -1;
        var date &#x3D; new Date(time);
        var iso_time &#x3D; date.toISOString();
        var msec_time &#x3D; date.getTime();
        if (time_tariffs.length&#x3D;&#x3D;0) return ret_index;
        var index &#x3D; time_tariffs.findIndex(x&#x3D;&gt;(new Date(x.time)).getTime()&gt;&#x3D;msec_time)
        if (index&#x3D;&#x3D;-1) {
          time_tariffs.push({
            time: iso_time,
            tariff: time_tariffs[time_tariffs.length-1].tariff
          })
          ret_index &#x3D; time_tariffs.length-1;
        } else {
          var time_tariff &#x3D; time_tariffs[index];
          if ((new Date(time_tariff.time)).getTime()&#x3D;&#x3D;msec_time) {
            ret_index &#x3D; index
          } else {
            if (index&#x3D;&#x3D;0) {
              time_tariffs.splice(0,0, {
                time: iso_time,
                tariff: null
              })
              ret_index &#x3D; 0;
            } else {
              time_tariffs.splice(index,0, {
                time: iso_time,
                tariff: time_tariffs[index-1].tariff
              })
              ret_index &#x3D; index;
            }
          }
        }
        return ret_index;
      }

      var start_index &#x3D; insertTime(time_tariffs, start_time)
      var end_index &#x3D; insertTime(time_tariffs, end_time)
      if(end_index!&#x3D;-1 &amp;&amp; time_tariffs.length-(end_index+1)&gt;0) time_tariffs.splice(end_index+1, time_tariffs.length-(end_index+1))
      if(start_index&gt;0) time_tariffs.splice(0, start_index)

      if (time_tariffs.length&#x3D;&#x3D;0) return ret;

      var fluxQuery &#x3D; &#x27;&#x27;;
      var q_names &#x3D; []
      for (var n&#x3D;0; n&lt;time_tariffs.length-1; n++) {
        //var fluxQuery &#x3D; &#x27;&#x27;;
        var time_tariff0 &#x3D; time_tariffs[n];
        var time_tariff1 &#x3D; time_tariffs[n+1];

        //if (time_tariff.tariff&#x3D;&#x3D;null) continue;
        var q_name &#x3D; &#x27;q&#x27;+n;
        q_names.push(q_name)
        var time_tariff_time_start &#x3D; (new Date(time_tariff0.time)).toISOString();
        var time_tariff_time_stop &#x3D; (new Date(time_tariff1.time)).toISOString();
        if (time_tariffs.length&gt;2) fluxQuery +&#x3D; &#x60;${q_name}&#x3D;&#x60;
        fluxQuery +&#x3D; &#x60;from(bucket: &quot;${organization_name}&quot;)&#x60;;
        fluxQuery +&#x3D; &#x60; |&gt; range(start:${time_tariff_time_start}, stop:${time_tariff_time_stop})&#x60;;
      //  fluxQuery +&#x3D; &#x27; |&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_measurement&quot;] &#x3D;&#x3D; &quot;hermes_report&quot;)&#x27;;
        fluxQuery +&#x3D; &#x27; |&gt; filter(fn: (r) &#x3D;&gt; r[&quot;_field&quot;] &#x3D;&#x3D; &quot;SolarEnergy&quot;)&#x27;;
        fluxQuery +&#x3D; &#x60; |&gt; filter(fn: (r) &#x3D;&gt; ${device_names_str})&#x60;;
        fluxQuery +&#x3D; &#x60; |&gt; group(columns: [&quot;DeviceName&quot;])&#x60;;
        fluxQuery +&#x3D; &#x60; |&gt; sort(columns: [&quot;_time&quot;], desc: false)&#x60;;
        fluxQuery +&#x3D; &#x27; |&gt; difference(nonNegative: true)&#x27;
        fluxQuery +&#x3D; &#x27; |&gt; group()&#x27;;
        fluxQuery +&#x3D; &#x27; |&gt; sum()&#x27;;
        fluxQuery +&#x3D; &#x60; |&gt; map(fn: (r) &#x3D;&gt; ({ r with _time: ${time_tariff_time_start} }))&#x60;;
      }
      if (time_tariffs.length&gt;2) fluxQuery +&#x3D; &#x60;union(tables: [${q_names.join(&#x27;,&#x27;)}])&#x60;;
      var datas2:any &#x3D; await this.deviceDataService.queryByFlux(fluxQuery);

      total_amount &#x3D; 0;
      for (var data of datas2) {
        var time_tariff &#x3D; time_tariffs.find(x&#x3D;&gt;(new Date(x.time)).getTime()&#x3D;&#x3D;(new Date(data._time)).getTime())
        if (time_tariff!&#x3D;null) {
          time_tariff.diff_energy &#x3D; data._value
          if (time_tariff.tariff!&#x3D;null &amp;&amp; time_tariff.diff_energy!&#x3D;null) {
            time_tariff.amount &#x3D; time_tariff.tariff * time_tariff.diff_energy;
            total_amount +&#x3D; time_tariff.amount
          }
        }
      }
    } while(false);

    return {
      tariffs: iso_time_tariffs,
      incomes: time_tariffs,
      ess_hermes_income: ess_hermes_income,
      other_income: total_amount,
      total_income: total_amount + ess_hermes_income
    }

  }


}</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'DeviceReportService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
